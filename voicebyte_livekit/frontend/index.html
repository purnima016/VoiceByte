<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>VoiceByte ‚Äî AI Hospital Registration</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#EEF4FB;--bg2:#F8FBFF;--white:#FFFFFF;--blue:#1252A3;--blue2:#1A6FD4;
  --blue-light:#E8F0FB;--blue-mid:#C8DCF8;--green:#00936B;--green-light:#E6F6F2;
  --red:#D92D20;--red-light:#FEF0EE;--orange:#E07B12;--text:#0F2137;
  --text2:#4A6280;--text3:#8EA5BD;--border:#D8E6F5;--border2:#B8D0EE;
  --shadow:0 2px 16px rgba(18,82,163,0.08);--shadow2:0 8px 40px rgba(18,82,163,0.14);
  --radius:20px;--radius2:14px;--radius3:10px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden;}
.screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .35s ease,transform .35s cubic-bezier(.4,0,.2,1);transform:translateY(12px);z-index:1;padding:12px;}
.screen.active{opacity:1;pointer-events:all;transform:translateY(0);}
#sw{background:var(--bg);}
.wcard{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow2);border:1px solid var(--border);max-width:460px;width:100%;padding:44px 40px;display:flex;flex-direction:column;align-items:center;gap:22px;text-align:center;position:relative;overflow:hidden;animation:card-enter .5s cubic-bezier(.4,0,.2,1);}
@keyframes card-enter{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.wcard::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--blue),var(--blue2),#2DD4BF);}
.wlogo-wrap{width:80px;height:80px;position:relative;margin-top:8px;}
.wlogo{width:80px;height:80px;border-radius:22px;background:linear-gradient(135deg,var(--blue),var(--blue2));display:flex;align-items:center;justify-content:center;font-size:34px;box-shadow:0 8px 24px rgba(18,82,163,0.3);position:relative;z-index:1;animation:logo-float 4s ease-in-out infinite;}
@keyframes logo-float{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
.wtit{font-family:'Plus Jakarta Sans',sans-serif;font-size:34px;font-weight:800;color:var(--text);letter-spacing:-0.5px;line-height:1.1;}
.wtit .v{color:var(--blue);}
.wsub{font-size:14px;color:var(--text2);line-height:1.7;max-width:340px;}
.ekg-wrap{width:100%;height:36px;overflow:hidden;position:relative;}
.ekg-svg{position:absolute;left:0;top:0;width:200%;height:100%;animation:ekg-scroll 3s linear infinite;}
@keyframes ekg-scroll{from{transform:translateX(0);}to{transform:translateX(-50%);}}
.wlangs{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;}
.wlang{font-size:12px;font-weight:500;color:var(--text2);background:var(--bg);border:1px solid var(--border);padding:5px 12px;border-radius:20px;transition:all .2s;cursor:default;}
.sbtn{width:100%;padding:17px;border:none;border-radius:var(--radius2);background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 6px 24px rgba(18,82,163,0.35);transition:all .2s;}
.sbtn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(18,82,163,0.4);}
.wfoot{font-size:11px;color:var(--text3);}
#sd{background:var(--bg);}
.dcard{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow2);border:1px solid var(--border);max-width:420px;width:100%;padding:44px 36px;display:flex;flex-direction:column;align-items:center;gap:24px;text-align:center;animation:card-enter .4s cubic-bezier(.4,0,.2,1);}
.dmic-zone{position:relative;width:140px;height:140px;display:flex;align-items:center;justify-content:center;}
.dring{position:absolute;border-radius:50%;border:1.5px solid rgba(18,82,163,0.15);animation:dring-out 2.5s ease-out infinite;}
.dring:nth-child(1){inset:0;animation-delay:0s;}.dring:nth-child(2){inset:-16px;animation-delay:.5s;opacity:0.7;}.dring:nth-child(3){inset:-32px;animation-delay:1s;opacity:0.4;}
@keyframes dring-out{0%{transform:scale(1);opacity:0.6;}100%{transform:scale(1.25);opacity:0;}}
.dmic{width:96px;height:96px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--blue2));border:none;cursor:pointer;font-size:38px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 28px rgba(18,82,163,0.35);transition:all .3s;z-index:1;position:relative;}
.dmic.on{background:linear-gradient(135deg,var(--red),#B91C1C);box-shadow:0 8px 28px rgba(217,45,32,0.4);animation:mic-pulse .85s ease-in-out infinite;}
@keyframes mic-pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.06);}}
.swave{display:flex;align-items:center;gap:3px;height:28px;opacity:0;transition:opacity .3s;}
.swave.on{opacity:1;}
.sb{width:3px;border-radius:3px;background:linear-gradient(to top,var(--blue),var(--blue2));height:4px;animation:sw .9s ease-in-out infinite;}
.sb:nth-child(1){animation-delay:.0s;}.sb:nth-child(2){animation-delay:.1s;}.sb:nth-child(3){animation-delay:.2s;}.sb:nth-child(4){animation-delay:.3s;}.sb:nth-child(5){animation-delay:.15s;}.sb:nth-child(6){animation-delay:.05s;}.sb:nth-child(7){animation-delay:.25s;}.sb:nth-child(8){animation-delay:.1s;}
@keyframes sw{0%,100%{height:4px;}50%{height:22px;}}
.dtit{font-family:'Plus Jakarta Sans',sans-serif;font-size:21px;font-weight:700;color:var(--text);}
.dsub{font-size:13px;color:var(--text2);line-height:1.6;}
.lpills{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.lpill{padding:7px 15px;border-radius:30px;font-size:13px;font-weight:600;background:var(--bg);border:1.5px solid var(--border);color:var(--text2);cursor:default;transition:all .35s cubic-bezier(.4,0,.2,1);}
.lpill.on{background:var(--blue-light);border-color:var(--blue2);color:var(--blue);transform:scale(1.07);box-shadow:0 2px 12px rgba(18,82,163,0.15);}
.dhint{font-size:13px;color:var(--text3);min-height:18px;}
#si{flex-direction:column;align-items:center;background:var(--bg);padding:0;}
.iwrap{width:100%;max-width:640px;height:100vh;display:flex;flex-direction:column;}
.topbar{background:var(--white);border-bottom:1px solid var(--border);padding:11px 18px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 1px 8px rgba(18,82,163,0.06);}
.tl{display:flex;align-items:center;gap:10px;}
.bbtn{width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:14px;color:var(--text2);transition:all .2s;}
.ttit{font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:15px;color:var(--text);}
.ttit span{color:var(--blue);}
.lbadge{display:flex;align-items:center;gap:6px;background:var(--blue-light);border:1px solid var(--blue-mid);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;color:var(--blue);}
.ldot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:dot-blink 2s infinite;}
@keyframes dot-blink{0%,100%{opacity:1;}50%{opacity:0.3;}}
.prog-bar-wrap{background:var(--white);padding:0 18px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.prog-info{display:flex;justify-content:space-between;align-items:center;padding:8px 0 6px;}
.prog-label{font-size:12px;font-weight:600;color:var(--text2);}
.prog-pct{font-size:12px;font-weight:700;color:var(--blue);}
.prog-track{height:5px;background:var(--border);border-radius:5px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--blue2));border-radius:5px;transition:width .5s cubic-bezier(.4,0,.2,1);width:0%;}
.stepbar{background:var(--white);padding:12px 18px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.srow{display:flex;align-items:flex-start;}
.si-el{display:flex;flex-direction:column;align-items:center;flex:1;position:relative;gap:5px;}
.si-el:not(:last-child)::after{content:'';position:absolute;top:17px;left:calc(50% + 18px);right:calc(-50% + 18px);height:2px;background:var(--border);z-index:0;transition:background .4s;}
.si-el.done:not(:last-child)::after{background:var(--blue);}
.sico{width:34px;height:34px;border-radius:50%;background:var(--bg);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;z-index:1;transition:all .3s;}
.si-el.active .sico{border-color:var(--blue);background:var(--blue-light);box-shadow:0 0 0 4px rgba(18,82,163,0.08);}
.si-el.done .sico{border-color:var(--blue);background:var(--blue);}
.slabel{font-size:9px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px;}
.si-el.active .slabel{color:var(--blue);}
.si-el.done .slabel{color:var(--blue);}
.chint{text-align:center;font-size:10px;color:var(--text3);margin-top:4px;}
.chat{flex:1;overflow-y:auto;padding:16px 18px;display:flex;flex-direction:column;gap:12px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.brow{display:flex;gap:8px;align-items:flex-end;animation:msg-in .3s ease;}
@keyframes msg-in{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
.brow.bot{flex-direction:row;}.brow.usr{flex-direction:row-reverse;}
.av{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.av.bav{background:linear-gradient(135deg,var(--blue),var(--blue2));}.av.uav{background:var(--blue-light);border:1.5px solid var(--blue-mid);}
.bbl{max-width:78%;padding:11px 15px;border-radius:18px;font-size:14px;line-height:1.55;}
.bbl.bot{background:var(--white);border:1px solid var(--border);border-bottom-left-radius:4px;color:var(--text);box-shadow:0 2px 8px rgba(18,82,163,0.06);}
.bbl.usr{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;border-bottom-right-radius:4px;}
.btime{font-size:10px;opacity:0.45;margin-top:4px;}
.tbbl{background:var(--white);border:1px solid var(--border);padding:11px 15px;border-radius:18px;border-bottom-left-radius:4px;display:flex;gap:4px;align-items:center;box-shadow:0 2px 8px rgba(18,82,163,0.06);}
.td{width:6px;height:6px;border-radius:50%;background:var(--blue);opacity:0.5;animation:tb .9s ease-in-out infinite;}
.td:nth-child(2){animation-delay:.2s;}.td:nth-child(3){animation-delay:.4s;}
@keyframes tb{0%,80%,100%{transform:translateY(0);opacity:0.5;}40%{transform:translateY(-5px);opacity:1;}}
.bot-area{background:var(--white);border-top:1px solid var(--border);padding:18px 18px 26px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:11px;box-shadow:0 -2px 12px rgba(18,82,163,0.06);}
.imic-wrap{position:relative;width:80px;height:80px;display:flex;align-items:center;justify-content:center;}
.ir{position:absolute;inset:-12px;border-radius:50%;border:1.5px solid rgba(18,82,163,0.12);animation:imic-ring 2.5s ease-out infinite;}
@keyframes imic-ring{0%{transform:scale(1);opacity:0.5;}100%{transform:scale(1.35);opacity:0;}}
.imic{width:70px;height:70px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--blue2));border:none;font-size:26px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(18,82,163,0.35);transition:all .25s;z-index:1;position:relative;}
.imic:hover{transform:scale(1.04);}
.imic.on{background:linear-gradient(135deg,var(--red),#B91C1C);box-shadow:0 6px 20px rgba(217,45,32,0.4);animation:mic-pulse .85s ease-in-out infinite;}
.mstat{font-size:13px;font-weight:500;color:var(--text2);}
.mstat.on{color:var(--red);font-weight:600;}
.mobbar{width:100%;max-width:320px;background:var(--bg);border:2px solid var(--blue-mid);border-radius:var(--radius3);padding:10px 16px;font-family:'Plus Jakarta Sans',monospace;font-weight:700;font-size:20px;letter-spacing:4px;text-align:center;color:var(--blue);display:none;}
.mobbar.show{display:block;}
.keypad-wrap{display:none;width:100%;max-width:320px;flex-direction:column;gap:8px;}
.keypad-wrap.show{display:flex;}
.keypad-row{display:flex;gap:8px;justify-content:center;}
.kbtn{width:88px;height:48px;border-radius:var(--radius3);border:1.5px solid var(--border);background:var(--white);font-family:'Plus Jakarta Sans',sans-serif;font-weight:600;font-size:20px;cursor:pointer;color:var(--text);transition:all .15s;box-shadow:0 2px 6px rgba(18,82,163,0.06);}
.kbtn:hover{background:var(--blue-light);border-color:var(--blue-mid);color:var(--blue);}
.kbtn:active{transform:scale(0.93);}
.kbtn.del{font-size:15px;color:var(--red);border-color:rgba(217,45,32,0.2);}
.kbtn.ok{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;border-color:transparent;box-shadow:0 4px 14px rgba(18,82,163,0.3);}
#sc{background:var(--bg);padding:16px;overflow-y:auto;align-items:center;justify-content:center;}
.ccard{background:var(--white);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow2);width:100%;max-width:560px;overflow:hidden;margin:auto;}
.chead{background:linear-gradient(135deg,var(--blue-light),#F0F8FF);border-bottom:1px solid var(--border);padding:22px 26px;}
.chead-badge{display:inline-flex;align-items:center;gap:6px;background:var(--blue);color:#fff;font-size:11px;font-weight:700;letter-spacing:0.5px;padding:4px 11px;border-radius:20px;text-transform:uppercase;margin-bottom:10px;}
.chead-t{font-family:'Plus Jakarta Sans',sans-serif;font-size:19px;font-weight:700;color:var(--text);}
.chead-s{font-size:13px;color:var(--text2);margin-top:3px;}
.crows{padding:18px 26px;display:flex;flex-direction:column;gap:9px;}
.crow{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius3);}
.crow-l{font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:1px;}
.crow-v{font-weight:600;font-size:14px;color:var(--text);margin-top:2px;}
.crow-edit{background:none;border:1.5px solid var(--border);border-radius:7px;padding:5px 11px;font-size:12px;color:var(--blue);cursor:pointer;font-weight:600;font-family:'Inter',sans-serif;transition:all .2s;}
.clang-msg{text-align:center;padding:0 26px 14px;font-size:13px;color:var(--text2);}
.cbtns{display:flex;gap:11px;padding:0 26px 22px;}
.cbtn{flex:1;padding:14px;border-radius:var(--radius2);border:none;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:14px;transition:all .2s;}
.cbtn-confirm{background:linear-gradient(135deg,var(--green),#00785A);color:#fff;box-shadow:0 4px 14px rgba(0,147,107,0.3);}
.cbtn-back{background:var(--white);color:var(--text2);border:1.5px solid var(--border);}
#se{background:linear-gradient(135deg,#FEF0EE,#FFF5F5);}
.e-top-bar{position:fixed;top:3px;left:0;right:0;height:5px;background:var(--red);animation:e-strobe .6s ease-in-out infinite;}
@keyframes e-strobe{0%,100%{opacity:1;}50%{opacity:0.2;}}
.ecard{background:var(--white);border-radius:var(--radius);border:2px solid rgba(217,45,32,0.3);box-shadow:0 12px 48px rgba(217,45,32,0.2);padding:40px 48px;text-align:center;display:flex;flex-direction:column;align-items:center;gap:20px;max-width:440px;width:100%;}
.eico{font-size:64px;animation:shk .5s infinite;}
@keyframes shk{0%,100%{transform:translateX(0);}25%{transform:translateX(-7px);}75%{transform:translateX(7px);}}
.etit{font-family:'Plus Jakarta Sans',sans-serif;font-size:clamp(24px,4vw,36px);font-weight:800;color:var(--red);}
.esub{font-size:15px;color:var(--text2);}
.efl{background:var(--red-light);border:2px solid rgba(217,45,32,0.25);border-radius:16px;padding:20px 40px;text-align:center;width:100%;}
.efl-l{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:rgba(217,45,32,0.7);font-weight:700;}
.efl-n{font-family:'Plus Jakarta Sans',sans-serif;font-size:80px;font-weight:800;color:var(--red);line-height:1;}
.efl-w{font-size:14px;color:var(--text2);margin-top:4px;}
#sr2{background:var(--bg);flex-direction:column;gap:14px;padding:16px;overflow-y:auto;align-items:center;}
.rcard{background:var(--white);border-radius:var(--radius);border:1px solid var(--border);box-shadow:var(--shadow2);width:100%;max-width:580px;overflow:hidden;}
.rhead{background:linear-gradient(135deg,var(--blue),var(--blue2));padding:20px 26px;display:flex;align-items:center;justify-content:space-between;}
.rlogo{font-family:'Plus Jakarta Sans',sans-serif;font-size:20px;font-weight:800;color:#fff;}
.rlogo span{color:#93C5FD;}
.rreg{text-align:right;}
.rreg-l{font-size:10px;letter-spacing:1px;color:rgba(255,255,255,0.65);text-transform:uppercase;font-weight:600;}
.rreg strong{display:block;font-size:13px;font-weight:700;color:#fff;margin-top:3px;letter-spacing:1px;font-family:'Plus Jakarta Sans',monospace;}
.rdrow{background:var(--blue-light);border-bottom:1px solid var(--border);padding:18px 26px;display:flex;align-items:center;justify-content:space-between;}
.rdname{font-family:'Plus Jakarta Sans',sans-serif;font-size:21px;font-weight:700;color:var(--blue);}
.rddoc{font-size:12px;color:var(--text2);margin-top:3px;}
.rflb{text-align:right;}
.rfll{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);font-weight:600;}
.rfln{font-family:'Plus Jakarta Sans',sans-serif;font-size:72px;font-weight:800;color:var(--blue);line-height:0.9;}
.rflw{font-size:11px;color:var(--text2);margin-top:2px;}
.rtoken{background:linear-gradient(135deg,var(--green-light),#F0FAF6);border-bottom:1px solid var(--border);padding:12px 26px;display:flex;align-items:center;justify-content:space-between;}
.rtoken-l{font-size:11px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:1px;}
.rtoken-n{font-family:'Plus Jakarta Sans',sans-serif;font-size:22px;font-weight:800;color:var(--green);}
.rtoken-w{font-size:12px;color:var(--text2);}
.rbody{padding:14px 26px;display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.rf{display:flex;flex-direction:column;gap:4px;}
.rf.full{grid-column:1/-1;}
.rfl2{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);font-weight:600;}
.rfv{font-weight:600;font-size:14px;color:var(--text);}
.spills{display:flex;flex-wrap:wrap;gap:5px;margin-top:4px;}
.spill{background:var(--blue-light);color:var(--blue);font-size:12px;font-weight:600;padding:3px 11px;border-radius:18px;border:1px solid var(--blue-mid);}
.rfoot{padding:11px 26px;background:var(--bg2);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.rtime{font-size:11px;color:var(--text3);}
.pb{padding:4px 13px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;}
.pb.norm{background:var(--green-light);color:var(--green);border:1px solid rgba(0,147,107,0.2);}
.pb.hi{background:var(--red-light);color:var(--red);border:1px solid rgba(217,45,32,0.2);}
.ract{display:flex;gap:10px;width:100%;max-width:580px;}
.abtn{flex:1;padding:14px;border-radius:var(--radius2);border:none;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;}
.aprint{background:var(--white);color:var(--blue);border:2px solid var(--blue-mid);box-shadow:var(--shadow);}
.adl{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 4px 14px rgba(18,82,163,0.3);}
.cdwrap{width:100%;max-width:580px;}
.cdi{display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-bottom:5px;}
.cdt{height:4px;background:var(--border);border-radius:4px;overflow:hidden;}
.cdf{height:100%;background:linear-gradient(90deg,var(--blue),var(--blue2));border-radius:4px;transition:width 1s linear;}
.ovl{position:fixed;inset:0;z-index:200;background:rgba(238,244,251,0.88);backdrop-filter:blur(6px);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;opacity:0;pointer-events:none;transition:opacity .3s;}
.ovl.show{opacity:1;pointer-events:all;}
.spin{width:48px;height:48px;border-radius:50%;border:4px solid var(--border);border-top-color:var(--blue);animation:sp .75s linear infinite;}
@keyframes sp{to{transform:rotate(360deg);}}
.ovt{font-family:'Plus Jakarta Sans',sans-serif;font-weight:600;font-size:15px;color:var(--text2);}
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--text);color:#fff;padding:10px 22px;border-radius:30px;font-size:13px;font-weight:500;z-index:300;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;box-shadow:0 4px 20px rgba(15,33,55,0.3);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
@media print{body{background:#fff !important;}body *{visibility:hidden;}.rcard,.rcard *{visibility:visible;}.rcard{position:fixed;inset:0;width:100%;box-shadow:none;border-radius:0;}}
</style>
</head>
<body>

<div class="screen active" id="sw">
  <div class="wcard">
    <div class="wlogo-wrap"><div class="wlogo">üè•</div></div>
    <div class="wtit"><span class="v">Voice</span>Byte</div>
    <div class="ekg-wrap">
      <svg class="ekg-svg" viewBox="0 0 800 36" preserveAspectRatio="none">
        <polyline points="0,18 80,18 100,18 110,4 120,32 130,18 140,18 220,18 240,18 250,4 260,32 270,18 280,18 360,18 380,18 390,4 400,32 410,18 420,18 500,18 520,18 530,4 540,32 550,18 560,18 640,18 660,18 670,4 680,32 690,18 700,18 800,18"
          fill="none" stroke="#1A6FD4" stroke-width="1.5" opacity="0.35"/>
      </svg>
    </div>
    <p class="wsub">AI-powered hospital self-registration.<br>Speak in your language ‚Äî we understand you.</p>
    <div class="wlangs">
      <span class="wlang">English</span><span class="wlang">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
      <span class="wlang">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</span><span class="wlang">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</span><span class="wlang">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</span>
    </div>
    <button class="sbtn" id="startBtn">üé§ &nbsp;Start Voice Registration</button>
    <p class="wfoot">City General Hospital &nbsp;¬∑&nbsp; Powered by VoiceByte AI</p>
  </div>
</div>

<div class="screen" id="sd">
  <div class="dcard">
    <div class="dmic-zone">
      <div class="dring"></div><div class="dring"></div><div class="dring"></div>
      <button class="dmic" id="dmic">üé§</button>
    </div>
    <div class="swave" id="soundwave">
      <div class="sb"></div><div class="sb"></div><div class="sb"></div>
      <div class="sb"></div><div class="sb"></div><div class="sb"></div>
      <div class="sb"></div><div class="sb"></div>
    </div>
    <div class="dtit">Speak a few words</div>
    <p class="dsub">Say anything in your language.<br>We detect it automatically.</p>
    <div class="lpills">
      <span class="lpill" id="lp-en">English</span>
      <span class="lpill" id="lp-hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
      <span class="lpill" id="lp-te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</span>
      <span class="lpill" id="lp-ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</span>
      <span class="lpill" id="lp-ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</span>
    </div>
    <p class="dhint" id="dhint" style="display:none"></p>
  </div>
</div>

<div class="screen" id="si">
  <div class="iwrap">
    <div class="topbar">
      <div class="tl">
        <button class="bbtn" onclick="resetAll()">‚Üê</button>
        <span class="ttit"><span>Voice</span>Byte</span>
      </div>
      <div class="lbadge"><div class="ldot"></div><span id="langLbl">English</span></div>
    </div>
    <div class="prog-bar-wrap">
      <div class="prog-info">
        <span class="prog-label" id="prog-label">Step 1 of 5</span>
        <span class="prog-pct" id="prog-pct">0%</span>
      </div>
      <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
    </div>
    <div class="stepbar">
      <div class="srow">
        <div class="si-el active" id="si-1"><div class="sico">üë§</div><div class="slabel">Name</div></div>
        <div class="si-el" id="si-2"><div class="sico">üéÇ</div><div class="slabel">Age</div></div>
        <div class="si-el" id="si-3"><div class="sico">üì±</div><div class="slabel">Mobile</div></div>
        <div class="si-el" id="si-4"><div class="sico">üè•</div><div class="slabel">Symptoms</div></div>
        <div class="si-el" id="si-5"><div class="sico">üìÖ</div><div class="slabel">Duration</div></div>
      </div>
      <div class="chint">‚úÖ Tap any completed step to correct it</div>
    </div>
    <div class="chat" id="chat"></div>
    <div class="bot-area">
      <div class="imic-wrap">
        <button class="imic" id="mbtn"><div class="ir"></div>üé§</button>
      </div>
      <span class="mstat" id="mstat">üëÜ Tap mic to speak</span>
      <div class="mobbar" id="mobBar">_ _ _ _ _ _ _ _ _ _</div>
      <div class="keypad-wrap" id="keypad">
        <div class="keypad-row">
          <button class="kbtn" onclick="kp('1')">1</button>
          <button class="kbtn" onclick="kp('2')">2</button>
          <button class="kbtn" onclick="kp('3')">3</button>
        </div>
        <div class="keypad-row">
          <button class="kbtn" onclick="kp('4')">4</button>
          <button class="kbtn" onclick="kp('5')">5</button>
          <button class="kbtn" onclick="kp('6')">6</button>
        </div>
        <div class="keypad-row">
          <button class="kbtn" onclick="kp('7')">7</button>
          <button class="kbtn" onclick="kp('8')">8</button>
          <button class="kbtn" onclick="kp('9')">9</button>
        </div>
        <div class="keypad-row">
          <button class="kbtn del" onclick="kpDel()">‚å´ Del</button>
          <button class="kbtn" onclick="kp('0')">0</button>
          <button class="kbtn ok" onclick="kpOk()">‚úì OK</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="screen" id="sc">
  <div style="width:100%;max-width:520px;margin:auto;">
    <div class="ccard">
      <div class="chead">
        <div class="chead-badge">üìã Review Details</div>
        <div class="chead-t" id="confirm-title">Please confirm your details</div>
        <div class="chead-s" id="confirm-sub">Check and tap Edit to correct anything</div>
      </div>
      <div class="crows" id="confirmRows"></div>
      <div class="clang-msg" id="confirm-lang-msg"></div>
      <div class="cbtns">
        <button class="cbtn cbtn-back" onclick="goBackToIntake()">‚úèÔ∏è Edit</button>
        <button class="cbtn cbtn-confirm" id="confirmBtn">‚úÖ Confirm &amp; Proceed</button>
      </div>
    </div>
  </div>
</div>

<div class="screen" id="se">
  <div class="e-top-bar"></div>
  <div class="ecard">
    <div class="eico">üö®</div>
    <div class="etit">Emergency Detected!</div>
    <div class="esub">Staff have been alerted. Please stay calm.</div>
    <div class="efl">
      <div class="efl-l">Go immediately to floor</div>
      <div class="efl-n">0</div>
      <div class="efl-w">Ground Floor ¬∑ Emergency Ward</div>
    </div>
  </div>
</div>

<div class="screen" id="sr2">
  <div class="rcard" id="rcard">
    <div class="rhead">
      <div class="rlogo">Voice<span>Byte</span></div>
      <div class="rreg"><div class="rreg-l">Registration No.</div><strong id="r-reg">‚Äî</strong></div>
    </div>
    <div class="rdrow">
      <div>
        <div class="rdname" id="r-dept">‚Äî</div>
        <div class="rddoc" id="r-doc">‚Äî</div>
      </div>
      <div class="rflb">
        <div class="rfll">Floor</div>
        <div class="rfln" id="r-fl">1</div>
        <div class="rflw" id="r-flw">First Floor</div>
      </div>
    </div>
    <div id="r-multidept" style="display:none;margin:10px 16px;padding:10px;background:#f0f4ff;border-radius:10px;border-left:4px solid #3B82F6;">
      <div style="font-size:11px;font-weight:700;color:#1252A3;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">üìã Also Visit</div>
      <div id="r-multidept-list"></div>
    </div>
    <div class="rtoken">
      <div>
        <div class="rtoken-l">üé´ Token Number</div>
        <div class="rtoken-n" id="r-token">‚Äî</div>
      </div>
      <div class="rtoken-w" id="r-wait">Show this token at the department counter</div>
    </div>
    <div class="rbody">
      <div class="rf"><div class="rfl2">Patient Name</div><div class="rfv" id="r-name">‚Äî</div></div>
      <div class="rf"><div class="rfl2">Age</div><div class="rfv" id="r-age">‚Äî</div></div>
      <div class="rf"><div class="rfl2">Mobile</div><div class="rfv" id="r-mob">‚Äî</div></div>
      <div class="rf"><div class="rfl2">Language</div><div class="rfv" id="r-lang">‚Äî</div></div>
      <div class="rf full"><div class="rfl2">Symptoms</div><div class="spills" id="r-sym"></div></div>
      <div class="rf full"><div class="rfl2">Duration</div><div class="rfv" id="r-days">‚Äî</div></div>
    </div>
    <div class="rfoot">
      <div class="rtime" id="r-time">‚Äî</div>
      <div class="pb norm" id="r-pri">Normal Priority</div>
    </div>
  </div>
  <div class="ract">
    <button class="abtn aprint" onclick="doPrint()">üñ®Ô∏è &nbsp;Print Receipt</button>
    <button class="abtn adl" onclick="doDownload()">‚¨áÔ∏è &nbsp;Download</button>
  </div>
  <div class="cdwrap">
    <div class="cdi"><span id="cdmsg">Session expires after print/download</span><span id="cdnum"></span></div>
    <div class="cdt"><div class="cdf" id="cdf" style="width:0%"></div></div>
  </div>
</div>

<div class="ovl" id="ovl"><div class="spin"></div><div class="ovt" id="ovmsg">Processing‚Ä¶</div></div>
<div class="toast" id="toast"></div>

<script>
const BACKEND = (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost')
  ? 'http://127.0.0.1:5000'
  : window.location.origin;

function setSoundwave(on){ document.getElementById('soundwave').classList.toggle('on', on); }
function updateProgress(idx){
  const pct = Math.round((idx / 5) * 100);
  document.getElementById('prog-fill').style.width = pct + '%';
  document.getElementById('prog-pct').textContent = pct + '%';
  document.getElementById('prog-label').textContent = idx < 5 ? 'Step ' + (idx + 1) + ' of 5' : 'All steps complete';
}

const P = {
  English:{
    q:['What is your full name?','How old are you?','Please say your 10-digit mobile number digit by digit.','Please describe your health problem or symptoms.','How many days have you had this problem?'],
    retry:'Sorry, I did not understand. Please tap the mic and speak again.',
    confirm_title:'Please confirm your details',confirm_sub:'Check below and tap Edit to correct anything',
    confirm_msg:'If all details are correct, tap Confirm to proceed.',confirm_btn:'Confirm and Proceed',
    labels:['Name','Age','Mobile','Symptoms','Duration'],floor_msg:'Please go to floor number '
  },
  Hindi:{
    q:['‡§Ü‡§™‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?','‡§Ü‡§™‡§ï‡•Ä ‡§â‡§Æ‡•ç‡§∞ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?','‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ 10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§','‡§Ö‡§™‡§®‡•Ä ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä ‡§Ø‡§æ ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§¨‡§§‡§æ‡§è‡§Ç‡•§','‡§ï‡§ø‡§§‡§®‡•á ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§∏‡•á ‡§Ø‡§π ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•à?'],
    retry:'‡§Æ‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç, ‡§∏‡§Æ‡§ù ‡§®‡§π‡•Ä‡§Ç ‡§Ü‡§Ø‡§æ‡•§ ‡§Æ‡§æ‡§á‡§ï ‡§¶‡§¨‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§',
    confirm_title:'‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•á ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç',confirm_sub:'‡§®‡•Ä‡§ö‡•á ‡§¶‡•á‡§ñ‡•á‡§Ç ‡§î‡§∞ ‡§ó‡§≤‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§∏‡•Å‡§ß‡§æ‡§∞‡•á‡§Ç',
    confirm_msg:'‡§Ö‡§ó‡§∞ ‡§∏‡§¨ ‡§∏‡§π‡•Ä ‡§π‡•à ‡§§‡•ã ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç‡•§',confirm_btn:'‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç',
    labels:['‡§®‡§æ‡§Æ','‡§â‡§Æ‡•ç‡§∞','‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤','‡§≤‡§ï‡•ç‡§∑‡§£','‡§Ö‡§µ‡§ß‡§ø'],floor_msg:'‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡§Ç‡§ú‡§ø‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§ú‡§æ‡§è‡§Ç '
  },
  Telugu:{
    q:['‡∞Æ‡±Ä ‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞ø ‡∞™‡±á‡∞∞‡±Å ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞Ç‡∞°‡∞ø.','‡∞Æ‡±Ä ‡∞µ‡∞Ø‡∞∏‡±Å ‡∞é‡∞Ç‡∞§?','‡∞Æ‡±Ä 10 ‡∞Ö‡∞Ç‡∞ï‡±Ü‡∞≤ ‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞Ç‡∞°‡∞ø.','‡∞Æ‡±Ä ‡∞Ö‡∞®‡∞æ‡∞∞‡±ã‡∞ó‡±ç‡∞Ø‡∞Ç ‡∞≤‡±á‡∞¶‡∞æ ‡∞≤‡∞ï‡±ç‡∞∑‡∞£‡∞æ‡∞≤‡±Å ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞Ç‡∞°‡∞ø.','‡∞é‡∞®‡±ç‡∞®‡∞ø ‡∞∞‡±ã‡∞ú‡±Å‡∞≤‡±Å‡∞ó‡∞æ ‡∞à ‡∞∏‡∞Æ‡∞∏‡±ç‡∞Ø ‡∞â‡∞Ç‡∞¶‡∞ø?'],
    retry:'‡∞ï‡±ç‡∞∑‡∞Æ‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø, ‡∞Ö‡∞∞‡±ç‡∞•‡∞Ç ‡∞ï‡∞æ‡∞≤‡±á‡∞¶‡±Å. ‡∞Æ‡±à‡∞ï‡±ç ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞ø ‡∞Æ‡∞≥‡±ç‡∞≥‡±Ä ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞Ç‡∞°‡∞ø.',
    confirm_title:'‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±Ä ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø',confirm_sub:'‡∞¶‡∞ø‡∞ó‡±Å‡∞µ ‡∞ö‡±Ç‡∞∏‡∞ø ‡∞§‡∞™‡±ç‡∞™‡±Å‡∞≤‡±Å ‡∞∏‡∞∞‡∞ø‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø',
    confirm_msg:'‡∞Ö‡∞®‡±ç‡∞®‡±Ä ‡∞∏‡∞∞‡±à‡∞®‡∞µ‡±à‡∞§‡±á ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞ø‡∞Ç‡∞ö‡±Å ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø.',confirm_btn:'‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞ø‡∞Ç‡∞ö‡±Å',
    labels:['‡∞™‡±á‡∞∞‡±Å','‡∞µ‡∞Ø‡∞∏‡±Å','‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç','‡∞≤‡∞ï‡±ç‡∞∑‡∞£‡∞æ‡∞≤‡±Å','‡∞µ‡±ç‡∞Ø‡∞µ‡∞ß‡∞ø'],floor_msg:'‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Ö‡∞Ç‡∞§‡∞∏‡±ç‡∞§‡±Å ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞ï‡∞ø ‡∞µ‡±Ü‡∞≥‡±ç‡∞≥‡∞Ç‡∞°‡∞ø '
  },
  Tamil:{
    q:['‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡ØÅ‡Æ¥‡ØÅ ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç ‡Æö‡Øä‡Æ≤‡Øç‡Æ≤‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.','‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡ÆØ‡Æ§‡ØÅ ‡Æé‡Æ©‡Øç‡Æ©?','‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç 10 ‡Æá‡Æ≤‡Æï‡Øç‡Æï ‡ÆÆ‡Øä‡Æ™‡Øà‡Æ≤‡Øç ‡Æé‡Æ£‡Øç ‡Æö‡Øä‡Æ≤‡Øç‡Æ≤‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.','‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æâ‡Æü‡Æ≤‡Øç‡Æ®‡Æ≤ ‡Æ™‡Æø‡Æ∞‡Æö‡Øç‡Æö‡Æ©‡Øà ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡ÆÖ‡Æ±‡Æø‡Æï‡ØÅ‡Æ±‡Æø‡Æï‡Æ≥‡Øà ‡Æö‡Øä‡Æ≤‡Øç‡Æ≤‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.','‡Æé‡Æ§‡Øç‡Æ§‡Æ©‡Øà ‡Æ®‡Ææ‡Æü‡Øç‡Æï‡Æ≥‡Ææ‡Æï ‡Æá‡Æ®‡Øç‡Æ§ ‡Æ™‡Æø‡Æ∞‡Æö‡Øç‡Æö‡Æ©‡Øà ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ?'],
    retry:'‡ÆÆ‡Æ©‡Øç‡Æ©‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç, ‡Æ™‡ØÅ‡Æ∞‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÆ‡Øà‡Æï‡Øç‡Æï‡Øà ‡ÆÖ‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡Æø ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æö‡Øä‡Æ≤‡Øç‡Æ≤‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.',
    confirm_title:'‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æâ‡Æ±‡ØÅ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç',confirm_sub:'‡Æï‡ØÄ‡Æ¥‡Øá ‡Æ™‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡ØÅ ‡Æ§‡Æµ‡Æ±‡ØÅ‡Æï‡Æ≥‡Øà ‡Æ§‡Æø‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç',
    confirm_msg:'‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡ØÅ‡ÆÆ‡Øç ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æï ‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øç ‡Æâ‡Æ±‡ØÅ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.',confirm_btn:'‡Æâ‡Æ±‡ØÅ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ',
    labels:['‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç','‡Æµ‡ÆØ‡Æ§‡ØÅ','‡ÆÆ‡Øä‡Æ™‡Øà‡Æ≤‡Øç','‡ÆÖ‡Æ±‡Æø‡Æï‡ØÅ‡Æ±‡Æø‡Æï‡Æ≥‡Øç','‡Æï‡Ææ‡Æ≤‡ÆÆ‡Øç'],floor_msg:'‡Æ§‡ÆØ‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æ§‡Æ≥‡ÆÆ‡Øç ‡Æé‡Æ£‡Øç‡Æ£‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æö‡ØÜ‡Æ≤‡Øç‡Æ≤‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç '
  },
  Malayalam:{
    q:['‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£ ‡¥™‡µá‡¥∞‡µç ‡¥™‡¥±‡¥Ø‡µÇ.','‡¥®‡¥ø‡¥ô‡µç‡¥ô‡µæ‡¥ï‡µç‡¥ï‡µç ‡¥é‡¥§‡µç‡¥∞ ‡¥µ‡¥Ø‡¥∏‡µç‡¥∏‡µç?','‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ 10 ‡¥Ö‡¥ï‡µç‡¥ï ‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥ì‡¥∞‡µã ‡¥Ö‡¥ï‡µç‡¥ï‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥™‡¥±‡¥Ø‡µÇ.','‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥Ü‡¥∞‡µã‡¥ó‡µç‡¥Ø ‡¥™‡µç‡¥∞‡¥∂‡µç‡¥®‡¥Ç ‡¥Ö‡¥≤‡µç‡¥≤‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥™‡¥±‡¥Ø‡µÇ.','‡¥é‡¥§‡µç‡¥∞ ‡¥¶‡¥ø‡¥µ‡¥∏‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥à ‡¥™‡µç‡¥∞‡¥∂‡µç‡¥®‡¥Ç ‡¥â‡¥£‡µç‡¥ü‡µç?'],
    retry:'‡¥ï‡µç‡¥∑‡¥Æ‡¥ø‡¥ï‡µç‡¥ï‡µÇ, ‡¥Æ‡¥®‡¥∏‡µç‡¥∏‡¥ø‡¥≤‡¥æ‡¥Ø‡¥ø‡¥≤‡µç‡¥≤. ‡¥Æ‡µà‡¥ï‡µç‡¥ï‡µç ‡¥ü‡¥æ‡¥™‡µç‡¥™‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µç ‡¥µ‡µÄ‡¥£‡µç‡¥ü‡µÅ‡¥Ç ‡¥™‡¥±‡¥Ø‡µÇ.',
    confirm_title:'‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥∏‡µç‡¥•‡¥ø‡¥∞‡µÄ‡¥ï‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÇ',confirm_sub:'‡¥§‡¥æ‡¥¥‡µÜ ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥§‡µÜ‡¥±‡µç‡¥±‡µÅ‡¥ï‡µæ ‡¥§‡¥ø‡¥∞‡µÅ‡¥§‡µç‡¥§‡µÇ',
    confirm_msg:'‡¥é‡¥≤‡µç‡¥≤‡¥æ‡¥Ç ‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥£‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥∏‡µç‡¥•‡¥ø‡¥∞‡µÄ‡¥ï‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÇ.',confirm_btn:'‡¥∏‡µç‡¥•‡¥ø‡¥∞‡µÄ‡¥ï‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÇ',
    labels:['‡¥™‡µá‡¥∞‡µç','‡¥™‡µç‡¥∞‡¥æ‡¥Ø‡¥Ç','‡¥Æ‡µä‡¥¨‡µà‡µΩ','‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ','‡¥¶‡µà‡µº‡¥ò‡µç‡¥Ø‡¥Ç'],floor_msg:'‡¥¶‡¥Ø‡¥µ‡¥æ‡¥Ø‡¥ø ‡¥®‡¥ø‡¥≤ ‡¥®‡¥Æ‡µç‡¥™‡µº ‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥™‡µã‡¥ï‡µÇ '
  }
};
function ph(){ return P[S.lang]||P.English; }

const KEYS=['name','age','mobile','symptoms','days'];
const SICOS=['üë§','üéÇ','üì±','üè•','üìÖ'];

const W2D={zero:'0',one:'1',two:'2',three:'3',four:'4',five:'5',six:'6',seven:'7',eight:'8',nine:'9',shunya:'0',ek:'1',do:'2',teen:'3',char:'4',paanch:'5',chhe:'6',saat:'7',aath:'8',nau:'9',sunna:'0',okati:'1',rendu:'2',madu:'3',nalugu:'4',ayidu:'5',aaru:'6',edu:'7',enimidi:'8',tommidi:'9'};
function digits(t){let s=t.toLowerCase();for(const[w,d] of Object.entries(W2D))s=s.replace(new RegExp('\\b'+w+'\\b','g'),d);return s.replace(/[^0-9]/g,'');}

const S={lang:'English',step:0,name:'',age:'',mobile:'',symptoms:'',days:'',department:'',floor:1,floorWord:'',doctor:'',keywords:[],emergency:false,reg:'',all_departments:[]};

function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function overlay(on,msg){document.getElementById('ovl').classList.toggle('show',on);if(msg)document.getElementById('ovmsg').textContent=msg;}
function toast(m,d=3000){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),d);}
function ts(){const d=new Date();return d.getHours()+':'+String(d.getMinutes()).padStart(2,'0')+' '+(d.getHours()<12?'am':'pm');}

function botMsg(html,typing=false){
  const c=document.getElementById('chat');
  if(typing){const r=document.createElement('div');r.className='brow bot';r.id='trow';r.innerHTML='<div class="av bav">ü§ñ</div><div class="tbbl"><div class="td"></div><div class="td"></div><div class="td"></div></div>';c.appendChild(r);c.scrollTop=c.scrollHeight;return;}
  const r=document.createElement('div');r.className='brow bot';r.innerHTML='<div class="av bav">ü§ñ</div><div class="bbl bot">'+html+'<div class="btime">'+ts()+'</div></div>';
  c.appendChild(r);c.scrollTop=c.scrollHeight;
}
function rmTyping(){const e=document.getElementById('trow');if(e)e.remove();}
function userMsg(t){const c=document.getElementById('chat');const r=document.createElement('div');r.className='brow usr';r.innerHTML='<div class="bbl usr">'+t+'<div class="btime">'+ts()+'</div></div><div class="av uav">üë§</div>';c.appendChild(r);c.scrollTop=c.scrollHeight;}

// ‚îÄ‚îÄ TTS: Browser SpeechSynthesis for all, gTTS backend for Telugu ‚îÄ‚îÄ
// (Telugu has no browser voice on laptop ‚Äî uses gTTS which works perfectly)
let curAudio = null;
var _synth = window.speechSynthesis;
var curAudioEl = null;
var SYNTH_LANG = {'English':'en-IN','Hindi':'hi-IN','Tamil':'ta-IN','Malayalam':'ml-IN','Telugu':'te-IN'};

if(_synth){ _synth.getVoices(); }
if(_synth){ _synth.onvoiceschanged = function(){ _synth.getVoices(); }; }

function speakBrowser(text, lang, cb){
  if(!_synth){if(cb)cb();return;}
  _synth.cancel();
  var utt = new SpeechSynthesisUtterance(text);
  utt.lang = SYNTH_LANG[lang]||'en-IN';
  utt.rate=0.88; utt.pitch=1.0; utt.volume=1.0;
  var _d=false;
  var done=function(){if(_d)return;_d=true;if(cb)cb();};
  utt.onend=done; utt.onerror=done;
  setTimeout(function(){_synth.speak(utt);},150);
}

function speakGTTS(text, lang, cb){
  var _d=false;
  var done=function(){if(_d)return;_d=true;curAudioEl=null;if(cb)cb();};
  fetch(BACKEND+'/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text,lang:lang})})
  .then(function(r){return r.blob();})
  .then(function(blob){
    var url=URL.createObjectURL(blob);
    var a=new Audio(url); curAudioEl=a;
    a.onended=function(){URL.revokeObjectURL(url);done();};
    a.onerror=function(){URL.revokeObjectURL(url);done();};
    var p=a.play();
    if(p!==undefined) p.catch(function(){URL.revokeObjectURL(url);curAudioEl=null;speakBrowser(text,lang,cb);});
  })
  .catch(function(){speakBrowser(text,lang,cb);});
}

function speak(text, lang, cb){
  if(!text){if(cb)cb();return;}
  stopAudio();
  // Telugu ‚Üí gTTS (perfect Telugu voice, no browser voice needed)
  // All others ‚Üí browser SpeechSynthesis (works on HTTPS, never blocked)
  if(lang==='Telugu'){
    speakGTTS(text,lang,cb);
  } else {
    speakBrowser(text,lang,cb);
  }
}

function stopAudio(){
  if(_synth) _synth.cancel();
  if(curAudioEl){curAudioEl.pause();curAudioEl.src='';curAudioEl=null;}
}

// ‚îÄ‚îÄ STEP UI ‚îÄ‚îÄ
function stepUI(idx,cls){
  const el=document.getElementById('si-'+(idx+1));if(!el)return;
  el.className='si-el '+cls;
  if(cls==='done'){el.querySelector('.sico').textContent='‚úÖ';el.style.cursor='pointer';el.onclick=()=>reaskStep(idx);}
  else{el.style.cursor='';el.onclick=null;}
  const done=document.querySelectorAll('.si-el.done').length;
  updateProgress(cls==='done'?done:idx);
}

// ‚îÄ‚îÄ MIC STATUS ‚îÄ‚îÄ
function micReady(){document.getElementById('mbtn').classList.remove('on');const s=document.getElementById('mstat');s.className='mstat';s.textContent='üëÜ Tap mic to speak';}
function micOn(){
  document.getElementById('mbtn').classList.add('on');
  const s=document.getElementById('mstat');s.className='mstat on';s.textContent='üî¥ Listening‚Ä¶ speak now';
  // Google-style ting sound using Web Audio API
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator();const g=ctx.createGain();
    o.connect(g);g.connect(ctx.destination);
    o.type='sine';o.frequency.value=880;
    g.gain.setValueAtTime(0.3,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4);
    o.start(ctx.currentTime);o.stop(ctx.currentTime+0.4);
  }catch(e){}
}
function micBusy(){document.getElementById('mbtn').classList.remove('on');const s=document.getElementById('mstat');s.className='mstat';s.textContent='‚è≥ Processing‚Ä¶';}

// ‚îÄ‚îÄ DETECT LANGUAGE ‚îÄ‚îÄ
let detectSR=null;
function startDetect(){
  show('sd');
  setTimeout(()=>listenDetect(),400);
  document.getElementById('dmic').onclick=()=>{stopAudio();listenDetect();};
}
function listenDetect(){
  if(detectSR){try{detectSR.abort();}catch(e){}detectSR=null;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('‚ùå Please use Google Chrome');return;}
  const sr=new SR();detectSR=sr;
  sr.lang='en-IN';sr.continuous=true;sr.interimResults=true;
  const btn=document.getElementById('dmic');
  btn.classList.add('on');setSoundwave(true);
  let final='',timer=null;
  sr.onresult=(e)=>{
    let f='';
    for(let x=e.resultIndex;x<e.results.length;x++){if(e.results[x].isFinal)f+=e.results[x][0].transcript;}
    if(f){final+=' '+f;clearTimeout(timer);timer=setTimeout(()=>{try{sr.stop();}catch(e){}},1200);}
  };
  sr.onend=async()=>{
    btn.classList.remove('on');setSoundwave(false);clearTimeout(timer);
    const t=final.trim();if(!t)return;
    await doDetect(t);
  };
  sr.onerror=()=>{btn.classList.remove('on');setSoundwave(false);};
  try{sr.start();}catch(e){}
}
async function doDetect(transcript){
  overlay(true,'Detecting your language‚Ä¶');
  function detectLangLocal(text){
    const te=(text.match(/[‡∞Ä-‡±ø]/g)||[]).length;const hi=(text.match(/[‡§Ä-‡•ø]/g)||[]).length;
    const ta=(text.match(/[‡ÆÄ-‡Øø]/g)||[]).length;const ml=(text.match(/[‡¥Ä-‡µø]/g)||[]).length;
    const max=Math.max(te,hi,ta,ml);if(max===0)return null;
    if(te===max)return 'Telugu';if(hi===max)return 'Hindi';if(ta===max)return 'Tamil';if(ml===max)return 'Malayalam';return null;
  }
  function detectLangFromWords(text){
    const t=text.toLowerCase();const scores={Telugu:0,Hindi:0,Tamil:0,Malayalam:0,English:0};
    ['naa','mee','nenu','meeru','okati','rendu','jwaram','noppi','vayasu','peru','kadupu','gunde'].forEach(w=>{if(t.includes(w))scores.Telugu+=2;});
    ['mera','meri','naam','umar','main','hoon','hai','nahi','dard','bukhar','mujhe'].forEach(w=>{if(t.includes(w))scores.Hindi+=2;});
    ['enakku','ennoda','peyar','vayasu','naan','irukku','vali','kaichal'].forEach(w=>{if(t.includes(w))scores.Tamil+=2;});
    ['entey','ente','peru','vayassu','njaan','aanu','veda','pani'].forEach(w=>{if(t.includes(w))scores.Malayalam+=2;});
    const best=Object.entries(scores).sort((a,b)=>b[1]-a[1])[0];return best[1]>=2?best[0]:null;
  }
  function applyLang(lang){
    overlay(false);S.lang=lang;
    const pm={English:'lp-en',Hindi:'lp-hi',Telugu:'lp-te',Tamil:'lp-ta',Malayalam:'lp-ml'};
    document.querySelectorAll('.lpill').forEach(p=>p.classList.remove('on'));
    document.getElementById(pm[S.lang])?.classList.add('on');
    document.getElementById('langLbl').textContent=S.lang;
    setTimeout(()=>startIntake(),400);
  }
  const local=detectLangLocal(transcript)||detectLangFromWords(transcript);
  if(local){applyLang(local);return;}
  try{
    const res=await fetch(BACKEND+'/detect-language',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({transcript})});
    const d=await res.json();applyLang(d.language||'English');
  }catch(e){overlay(false);toast('‚ùå Backend error ‚Äî is Flask running?');}
}

// ‚îÄ‚îÄ INTAKE ‚îÄ‚îÄ
function startIntake(){
  show('si');S.step=0;
  document.getElementById('chat').innerHTML='';
  updateProgress(0);setTimeout(()=>askStep(0),300);
}

// FIX: Double question prevention with both _stepLock and _stepRunning
let _stepLock=-1;
let _stepRunning=false;
function askStep(idx){
  if(idx>=KEYS.length){_stepLock=-1;_stepRunning=false;showConfirm();return;}
  if(_stepLock===idx && _stepRunning)return; // ‚Üê prevents double question
  _stepLock=idx;_stepRunning=true;
  S.step=idx;
  stepUI(idx,'active');updateProgress(idx);
  const key=KEYS[idx];const q=ph().q[idx];
  document.getElementById('mobBar').className='mobbar'+(key==='mobile'?' show':'');
  document.getElementById('keypad').className='keypad-wrap'+(key==='mobile'?' show':'');
  document.getElementById('mbtn').style.display=(key==='mobile'?'none':'');
  const mstatEl=document.getElementById('mstat');
  if(key==='mobile'){mobileDigits='';updateMobBar();mstatEl.className='mstat';mstatEl.textContent='‚å®Ô∏è Use keypad below';}
  botMsg(SICOS[idx]+' '+q);micReady();
  speak(q,S.lang,()=>{
    if(S.step===idx && key!=='mobile'){setTimeout(()=>{startListen(idx);},800);}
    else if(key==='mobile'){mstatEl.className='mstat';mstatEl.textContent='‚å®Ô∏è Use keypad below';}
  });
}

function reaskStep(idx){S[KEYS[idx]]='';show('si');botMsg('‚úèÔ∏è Re-entering: <b>'+KEYS[idx]+'</b>');askStep(idx);}
function goBackToIntake(){show('si');let lastIdx=0;for(let i=0;i<KEYS.length;i++){if(S[KEYS[i]])lastIdx=i+1;}lastIdx=Math.min(lastIdx,KEYS.length-1);askStep(lastIdx);}

function showConfirm(){
  const p=ph();
  document.getElementById('confirm-title').textContent=p.confirm_title;
  document.getElementById('confirm-sub').textContent=p.confirm_sub;
  document.getElementById('confirm-lang-msg').textContent=p.confirm_msg;
  document.getElementById('confirmBtn').textContent='‚úÖ '+p.confirm_btn;
  const rows=document.getElementById('confirmRows');rows.innerHTML='';
  const vals=[S.name,S.age,S.mobile,S.symptoms,S.days];
  KEYS.forEach((key,i)=>{
    const div=document.createElement('div');div.className='crow';
    div.innerHTML='<div><div class="crow-l">'+p.labels[i]+'</div><div class="crow-v">'+(vals[i]||'‚Äî')+'</div></div><button class="crow-edit" onclick="reaskStep('+i+')">‚úèÔ∏è Edit</button>';
    rows.appendChild(div);
  });
  show('sc');speak(p.confirm_msg,S.lang,null);
}
document.getElementById('confirmBtn').addEventListener('click',()=>finalize());

// ‚îÄ‚îÄ LISTENING ‚îÄ‚îÄ
let curSR=null;let mobileDigits='';
document.getElementById('mbtn').addEventListener('click',()=>{
  stopAudio();
  if(curSR){try{curSR.abort();}catch(e){}curSR=null;}
  setTimeout(()=>startListen(S.step),300);
});

let _listenLock=false;
function startListen(idx){
  if(_listenLock)return;
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('‚ùå Please use Google Chrome');return;}
  const key=KEYS[idx];
  if(key==='mobile'){const mstatEl=document.getElementById('mstat');mstatEl.className='mstat';mstatEl.textContent='‚å®Ô∏è Use keypad below';return;}
  _listenLock=true;
  const sr=new SR();curSR=sr;
  const SR_LANG={'English':'en-IN','Hindi':'hi-IN','Telugu':'te-IN','Tamil':'ta-IN','Malayalam':'ml-IN'};
  sr.lang=SR_LANG[S.lang]||'en-IN';
  sr.continuous=false;sr.interimResults=false;sr.maxAlternatives=3;
  micOn();
  let done=false;
  function finish(t){
    if(done)return;done=true;curSR=null;_listenLock=false;
    micBusy();
    if(!t){botMsg('üîÅ '+ph().retry);speak(ph().retry,S.lang,null);micReady();return;}
    userMsg(t);
    if(key==='mobile')handleMob(idx,t);
    else processAns(idx,t);
  }
  sr.onresult=(e)=>{let best='';for(let i=0;i<e.results.length;i++)for(let j=0;j<e.results[i].length;j++)if(e.results[i][j].transcript.length>best.length)best=e.results[i][j].transcript;finish(best.trim());};
  sr.onend=()=>{if(!done)finish('');};
  sr.onerror=(e)=>{if(e.error!=='aborted')finish('');};
  setTimeout(()=>{if(!done){try{sr.stop();}catch(e){}}},10000);
  try{sr.start();}catch(e){micReady();toast('Tap mic to try again');}
}

function updateMobBar(){document.getElementById('mobBar').textContent=mobileDigits.padEnd(10,'_').split('').join(' ');}
function handleMob(idx,t){
  mobileDigits=(mobileDigits+digits(t)).slice(0,10);updateMobBar();
  if(mobileDigits.length>=10){accept(idx,mobileDigits);return;}
  if(mobileDigits.length>=5){
    const need=10-mobileDigits.length;
    botMsg('üì± '+mobileDigits+' ‚Äî '+need+' more digits needed');
    const moreMsg={Telugu:'‡∞á‡∞Ç‡∞ï‡∞æ '+need+' ‡∞Ö‡∞Ç‡∞ï‡±Ü‡∞≤‡±Å ‡∞ö‡±Ü‡∞™‡±ç‡∞™‡∞Ç‡∞°‡∞ø.',Hindi:need+' ‡§Ö‡§Ç‡§ï ‡§î‡§∞ ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§',Tamil:need+' ‡Æá‡Æ≤‡Æï‡Øç‡Æï‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Øá‡Æ≤‡ØÅ‡ÆÆ‡Øç ‡Æö‡Øä‡Æ≤‡Øç‡Æ≤‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.',Malayalam:need+' ‡¥Ö‡¥ï‡µç‡¥ï‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡µÇ‡¥ü‡¥ø ‡¥™‡¥±‡¥Ø‡µÇ.',English:'Please say '+need+' more digits.'}[S.lang]||'Please say '+need+' more digits.';
    speak(moreMsg,S.lang,null);micReady();
  }else{botMsg('üîÅ '+ph().retry);speak(ph().retry,S.lang,null);micReady();}
}

async function processAns(idx,transcript){
  botMsg('',true);overlay(true,'Processing‚Ä¶');
  try{
    const res=await fetch(BACKEND+'/extract',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({field:KEYS[idx],transcript,lang:S.lang})});
    const d=await res.json();rmTyping();overlay(false);
    const val=(d.extracted||'').trim();
    if(!val||val.toLowerCase()==='unknown'||val==='No medical keywords found.'||val==='No duration found.'){
      botMsg('üîÅ '+ph().retry);speak(ph().retry,S.lang,null);micReady();return;
    }
    accept(idx,val);
  }catch(e){rmTyping();overlay(false);toast('‚ùå Server busy ‚Äî please try again');setTimeout(()=>{micReady();},1500);}
}

const CLANG={
  name:{Telugu:'‡∞Æ‡±Ä ‡∞™‡±á‡∞∞‡±Å ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞∂‡∞æ‡∞Ç',Hindi:'‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§ø‡§Ø‡§æ',Tamil:'‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ',Malayalam:'‡¥™‡µá‡¥∞‡µç ‡¥ï‡µÅ‡¥±‡¥ø‡¥ö‡µç‡¥ö‡µÅ',English:'Name recorded'},
  age:{Telugu:'‡∞µ‡∞Ø‡∞∏‡±Å ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞∂‡∞æ‡∞Ç',Hindi:'‡§â‡§Æ‡•ç‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡•Ä',Tamil:'‡Æµ‡ÆØ‡Æ§‡ØÅ ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ',Malayalam:'‡¥™‡µç‡¥∞‡¥æ‡¥Ø‡¥Ç ‡¥ï‡µÅ‡¥±‡¥ø‡¥ö‡µç‡¥ö‡µÅ',English:'Age recorded'},
  mobile:{Telugu:'‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞∂‡∞æ‡∞Ç',Hindi:'‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§ø‡§Ø‡§æ',Tamil:'‡ÆÆ‡Øä‡Æ™‡Øà‡Æ≤‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ',Malayalam:'‡¥Æ‡µä‡¥¨‡µà‡µΩ ‡¥ï‡µÅ‡¥±‡¥ø‡¥ö‡µç‡¥ö‡µÅ',English:'Mobile recorded'},
  symptoms:{Telugu:'‡∞≤‡∞ï‡±ç‡∞∑‡∞£‡∞æ‡∞≤‡±Å ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞∂‡∞æ‡∞Ç',Hindi:'‡§≤‡§ï‡•ç‡§∑‡§£ ‡§®‡•ã‡§ü ‡§ï‡§ø‡§è',Tamil:'‡ÆÖ‡Æ±‡Æø‡Æï‡ØÅ‡Æ±‡Æø‡Æï‡Æ≥‡Øç ‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ©',Malayalam:'‡¥≤‡¥ï‡µç‡¥∑‡¥£‡¥ô‡µç‡¥ô‡µæ ‡¥ï‡µÅ‡¥±‡¥ø‡¥ö‡µç‡¥ö‡µÅ',English:'Symptoms noted'},
  days:{Telugu:'‡∞µ‡±ç‡∞Ø‡∞µ‡∞ß‡∞ø ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞∂‡∞æ‡∞Ç',Hindi:'‡§Ö‡§µ‡§ß‡§ø ‡§®‡•ã‡§ü ‡§ï‡•Ä',Tamil:'‡Æï‡Ææ‡Æ≤‡ÆÆ‡Øç ‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ',Malayalam:'‡¥¶‡µà‡µº‡¥ò‡µç‡¥Ø‡¥Ç ‡¥ï‡µÅ‡¥±‡¥ø‡¥ö‡µç‡¥ö‡µÅ',English:'Duration noted'}
};

function accept(idx,val){
  const key=KEYS[idx];S[key]=val;rmTyping();
  const cm=(CLANG[key]||{})[S.lang]||(CLANG[key]||{})['English']||'Recorded';
  const next=()=>{stepUI(idx,'done');_stepLock=-1;_stepRunning=false;askStep(idx+1);};
  if(key==='mobile'){botMsg('‚úÖ '+cm);speak(cm,S.lang,next);}
  else if(key==='symptoms'){botMsg('‚úÖ <span style="font-size:12px;color:var(--text2)">'+val+'</span><br><b>'+cm+'</b>');speak(cm,S.lang,next);}
  else{botMsg('‚úÖ '+val+'<br><span style="font-size:12px;color:var(--text2)">'+cm+'</span>');speak(cm+'. '+val,S.lang,next);}
  document.getElementById('mobBar').className='mobbar';
  document.getElementById('keypad').className='keypad-wrap';
  document.getElementById('mbtn').style.display='';
}

async function finalize(){
  overlay(true,'Mapping department‚Ä¶');
  try{
    const res=await fetch(BACKEND+'/process',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name:S.name,age:S.age,mobile:S.mobile,symptoms:S.symptoms,days:S.days,language:S.lang,emergency:S.emergency})});
    const d=await res.json();overlay(false);
    Object.assign(S,{department:d.department,floor:d.floor,floorWord:d.floorWord,doctor:d.doctor,keywords:d.keywords,emergency:d.emergency,reg:d.registration_number,all_departments:d.all_departments||[]});
    if(S.emergency){
      show('se');
      const em={Telugu:'‡∞Ö‡∞§‡±ç‡∞Ø‡∞µ‡∞∏‡∞∞‡∞Ç! ‡∞ó‡±ç‡∞∞‡±å‡∞Ç‡∞°‡±ç ‡∞´‡±ç‡∞≤‡±ã‡∞∞‡±ç ‡∞ï‡∞ø ‡∞µ‡±Ü‡∞≥‡±ç‡∞≥‡∞Ç‡∞°‡∞ø.',Hindi:'‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤! ‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§´‡•ç‡§≤‡•ã‡§∞ ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç‡•§',Tamil:'‡ÆÖ‡Æµ‡Æö‡Æ∞‡Æ®‡Æø‡Æ≤‡Øà! ‡Æï‡ØÄ‡Æ¥‡Øç ‡Æ§‡Æ≥‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡Æö‡ØÜ‡Æ≤‡Øç‡Æ≤‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.',Malayalam:'‡¥Ö‡¥ü‡¥ø‡¥Ø‡¥®‡µç‡¥§‡¥∞‡¥Ç! ‡¥ó‡µç‡¥∞‡µó‡¥£‡µç‡¥ü‡µç ‡¥´‡µç‡¥≤‡µã‡¥±‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥™‡µã‡¥ï‡µÇ.',English:'Emergency! Go to Ground Floor immediately.'}[S.lang]||'Emergency!';
      speak(em,S.lang,null);setTimeout(()=>{show('sr2');fillReceipt();},7000);
    }else{
      const msg=ph().floor_msg+S.floor;show('sr2');fillReceipt();speak(msg,S.lang,null);
    }
  }catch(e){overlay(false);toast('‚ùå Connection issue ‚Äî tap mic and try again');micReady();}
}

function fillReceipt(){
  const d=new Date();
  const reg=S.reg||'VBT-'+d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0')+'-'+String(Math.floor(Math.random()*900)+100);
  const token='T-'+String(Math.floor(Math.random()*98)+1).padStart(2,'0');
  document.getElementById('r-reg').textContent=reg;
  document.getElementById('r-token').textContent=token;
  document.getElementById('r-dept').textContent=S.department||'‚Äî';
  document.getElementById('r-doc').textContent=S.doctor||'‚Äî';
  const multiEl=document.getElementById('r-multidept');
  const multiList=document.getElementById('r-multidept-list');
  const others=(S.all_departments||[]).filter(x=>x.name!==S.department&&x.name!=='Emergency');
  if(others.length>0){
    multiList.innerHTML=others.map(function(x){return '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #e0e7ff;font-size:13px;"><span style="font-weight:600;color:#1e293b;">üè• '+x.name+'</span><span style="color:#64748b;">Floor '+x.floor+' ¬∑ '+x.doctor+'</span></div>';}).join('');
    multiEl.style.display='block';
  }else{multiEl.style.display='none';}
  document.getElementById('r-fl').textContent=S.floor;
  document.getElementById('r-flw').textContent=S.floorWord||'‚Äî';
  document.getElementById('r-name').textContent=S.name||'‚Äî';
  document.getElementById('r-age').textContent=S.age?S.age+' years':'‚Äî';
  document.getElementById('r-mob').textContent=S.mobile||'‚Äî';
  document.getElementById('r-lang').textContent=S.lang;
  document.getElementById('r-days').textContent=S.days||'‚Äî';
  document.getElementById('r-time').textContent=d.toLocaleString('en-IN');
  const pri=document.getElementById('r-pri');
  if(S.emergency){pri.textContent='HIGH PRIORITY';pri.className='pb hi';}
  else{pri.textContent='Normal Priority';pri.className='pb norm';}
  const sw=document.getElementById('r-sym');sw.innerHTML='';
  (S.keywords||[]).forEach(k=>{const sp=document.createElement('span');sp.className='spill';sp.textContent=k;sw.appendChild(sp);});
}

let cdTimer,cdDone=false;
function doPrint(){window.print();toast('üñ®Ô∏è Sent to printer');setTimeout(startCD,1500);}
function doDownload(){
  const html='<!DOCTYPE html><html><head><meta charset="UTF-8"/></head><body>'+document.getElementById('rcard').outerHTML+'</body></html>';
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([html],{type:'text/html'}));a.download='VoiceByte-'+document.getElementById('r-reg').textContent+'.html';a.click();toast('‚¨áÔ∏è Downloaded!');setTimeout(startCD,1500);
}
function startCD(){
  if(cdDone)return;cdDone=true;let s=10;
  document.getElementById('cdmsg').textContent='Session expiring in';document.getElementById('cdnum').textContent=s+'s';document.getElementById('cdf').style.width='100%';
  clearInterval(cdTimer);cdTimer=setInterval(()=>{s--;document.getElementById('cdnum').textContent=s+'s';document.getElementById('cdf').style.width=(s/10*100)+'%';if(s<=0){clearInterval(cdTimer);resetAll();}},1000);
}

function resetAll(){
  clearInterval(cdTimer);cdDone=false;stopAudio();
  if(curSR){try{curSR.abort();}catch(e){}curSR=null;}
  _stepLock=-1;_stepRunning=false;_listenLock=false;
  Object.assign(S,{lang:'English',step:0,name:'',age:'',mobile:'',symptoms:'',days:'',department:'',floor:1,floorWord:'',doctor:'',keywords:[],emergency:false,reg:'',all_departments:[]});
  mobileDigits='';document.getElementById('chat').innerHTML='';document.getElementById('langLbl').textContent='English';
  document.querySelectorAll('.lpill').forEach(p=>p.classList.remove('on'));
  const icons=['üë§','üéÇ','üì±','üè•','üìÖ'];
  for(let i=1;i<=5;i++){const el=document.getElementById('si-'+i);el.className='si-el'+(i===1?' active':'');el.querySelector('.sico').textContent=icons[i-1];el.style.cursor='';el.onclick=null;}
  document.getElementById('mobBar').className='mobbar';updateProgress(0);show('sw');
}

// Voices preload
if(window.speechSynthesis){window.speechSynthesis.getVoices();window.speechSynthesis.onvoiceschanged=function(){window.speechSynthesis.getVoices();};}

document.getElementById('startBtn').addEventListener('click', function(){
  if(window.speechSynthesis){window.speechSynthesis.cancel();window.speechSynthesis.getVoices();}
  startDetect();
});

// Backend health ping (Render cold start splash)
(async function pingBackend(){
  const splash=document.createElement('div');
  splash.id='renderSplash';
  Object.assign(splash.style,{display:'none',position:'fixed',inset:'0',zIndex:'9999',background:'#0F2137',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:'18px',fontFamily:'sans-serif'});
  splash.innerHTML='<div style="font-size:56px">üè•</div><div style="font-size:26px;font-weight:800;color:#fff"><span style="color:#93C5FD">Voice</span>Byte</div><div style="color:rgba(255,255,255,0.7);font-size:15px">Starting up, please wait‚Ä¶</div><div style="width:180px;height:4px;background:rgba(255,255,255,0.15);border-radius:4px;overflow:hidden"><div id="splashBar" style="height:100%;width:0%;background:#3B82F6;border-radius:4px;transition:width 0.4s"></div></div><div id="splashMsg" style="color:rgba(255,255,255,0.4);font-size:12px">Connecting‚Ä¶</div>';
  document.body.appendChild(splash);
  let pct=0;const tick=setInterval(()=>{pct=Math.min(pct+3,88);document.getElementById('splashBar').style.width=pct+'%';},600);
  const slowTimer=setTimeout(()=>{splash.style.display='flex';document.getElementById('splashMsg').textContent='Free server waking up (may take 30-50s)‚Ä¶';},3000);
  try{await fetch(BACKEND+'/health',{cache:'no-store'});clearTimeout(slowTimer);clearInterval(tick);document.getElementById('splashBar').style.width='100%';setTimeout(()=>{splash.style.display='none';},400);}
  catch(e){clearInterval(tick);if(splash.style.display==='flex')document.getElementById('splashMsg').textContent='Cannot reach server. Check Flask is running.';}
})();

// Keypad
function kp(digit){if(mobileDigits.length>=10)return;mobileDigits+=digit;updateMobBar();}
function kpDel(){mobileDigits=mobileDigits.slice(0,-1);updateMobBar();}
function kpOk(){
  if(mobileDigits.length<7){const msg={Telugu:'10 ‡∞Ö‡∞Ç‡∞ï‡±Ü‡∞≤‡±Å ‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞ø‡∞ó‡∞æ ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø',Hindi:'10 ‡§Ö‡§Ç‡§ï ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç',Tamil:'10 ‡Æá‡Æ≤‡Æï‡Øç‡Æï‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç',Malayalam:'10 ‡¥Ö‡¥ï‡µç‡¥ï‡¥ô‡µç‡¥ô‡µæ ‡¥®‡µΩ‡¥ï‡µÇ',English:'Please enter at least 7 digits'}[S.lang]||'Please enter at least 7 digits';toast(msg);return;}
  userMsg(mobileDigits);accept(S.step,mobileDigits);
}

// Idle detection
const IDLE_SEC=30;let idleTimer=null;let idleLangTimer=null;
const IDLE_MSGS=[{lang:'English',msg:'Touch the button to register'},{lang:'‡§π‡§ø‡§Ç‡§¶‡•Ä',msg:'‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç'},{lang:'‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å',msg:'‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞¨‡∞ü‡∞®‡±ç ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø'},{lang:'‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç',msg:'‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ ‡Æ™‡Øä‡Æ§‡Øç‡Æ§‡Ææ‡Æ©‡Øà ‡Æ§‡Øä‡Æü‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç'},{lang:'‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç',msg:'‡¥∞‡¥ú‡¥ø‡¥∏‡µç‡¥ü‡µç‡¥∞‡µá‡¥∑‡¥®‡¥æ‡¥Ø‡¥ø ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ ‡¥Ö‡¥Æ‡µº‡¥§‡µç‡¥§‡µÇ'}];
let hasInteracted=false;
function resetIdleTimer(){clearTimeout(idleTimer);if(document.getElementById('sw').classList.contains('active')&&hasInteracted){idleTimer=setTimeout(showIdle,IDLE_SEC*1000);}}
document.addEventListener('click',()=>{hasInteracted=true;resetIdleTimer();},{once:true});
document.addEventListener('touchstart',()=>{hasInteracted=true;resetIdleTimer();},{once:true,passive:true});
setTimeout(()=>{hasInteracted=true;resetIdleTimer();},IDLE_SEC*1000);
function showIdle(){
  document.getElementById('idle-overlay').style.display='flex';let i=0;clearInterval(idleLangTimer);
  function rotate(){const el=document.getElementById('idle-lang-msg');el.style.opacity='0';setTimeout(()=>{el.textContent=IDLE_MSGS[i].lang+' ‚Äî '+IDLE_MSGS[i].msg;el.style.opacity='1';i=(i+1)%IDLE_MSGS.length;},400);}
  rotate();idleLangTimer=setInterval(rotate,2500);
}
function dismissIdle(){clearInterval(idleLangTimer);document.getElementById('idle-overlay').style.display='none';resetAll();setTimeout(resetIdleTimer,500);}
const _baseResetAll=resetAll;
resetAll=function(){_baseResetAll();setTimeout(resetIdleTimer,500);};
['click','touchstart','keydown'].forEach(ev=>{document.addEventListener(ev,()=>{hasInteracted=true;if(document.getElementById('idle-overlay').style.display!=='flex')resetIdleTimer();},{passive:true});});
</script>

<div id="idle-overlay" style="display:none;position:fixed;inset:0;z-index:500;background:linear-gradient(135deg,#0F2137,#1252A3);flex-direction:column;align-items:center;justify-content:center;gap:24px;text-align:center;padding:32px;">
  <div style="font-size:80px;animation:logo-float 3s ease-in-out infinite;">üè•</div>
  <div style="font-family:'Plus Jakarta Sans',sans-serif;font-size:36px;font-weight:800;color:#fff;">VoiceByte</div>
  <div style="font-size:15px;color:rgba(255,255,255,0.6);">AI-powered Hospital Registration</div>
  <div id="idle-lang-msg" style="font-size:20px;font-weight:600;color:#93C5FD;min-height:30px;transition:opacity .4s;"></div>
  <button onclick="dismissIdle()" style="margin-top:12px;padding:20px 52px;border:none;border-radius:18px;background:#fff;color:#1252A3;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:18px;cursor:pointer;box-shadow:0 8px 32px rgba(0,0,0,0.3);">üé§ &nbsp;Touch here to start</button>
  <div style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:8px;">City General Hospital ¬∑ Powered by VoiceByte AI</div>
</div>

</body>
</html>