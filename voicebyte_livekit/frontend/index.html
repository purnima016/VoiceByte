<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>VoiceByte â€” AI Hospital Registration</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN SYSTEM â€” Clinical Clarity Theme
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:        #EEF4FB;
  --bg2:       #F8FBFF;
  --white:     #FFFFFF;
  --blue:      #1252A3;
  --blue2:     #1A6FD4;
  --blue-light:#E8F0FB;
  --blue-mid:  #C8DCF8;
  --green:     #00936B;
  --green-light:#E6F6F2;
  --red:       #D92D20;
  --red-light: #FEF0EE;
  --orange:    #E07B12;
  --text:      #0F2137;
  --text2:     #4A6280;
  --text3:     #8EA5BD;
  --border:    #D8E6F5;
  --border2:   #B8D0EE;
  --shadow:    0 2px 16px rgba(18,82,163,0.08);
  --shadow2:   0 8px 40px rgba(18,82,163,0.14);
  --radius:    20px;
  --radius2:   14px;
  --radius3:   10px;
}

*{margin:0;padding:0;box-sizing:border-box;}

body{
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow:hidden;
}

/* No top bar */

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN TRANSITIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;
  transition:opacity .35s ease, transform .35s cubic-bezier(.4,0,.2,1);
  transform:translateY(12px);
  z-index:1;
  padding:12px;
}
.screen.active{opacity:1;pointer-events:all;transform:translateY(0);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WELCOME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sw{background:var(--bg);}

.wcard{
  background:var(--white);
  border-radius:var(--radius);
  box-shadow:var(--shadow2);
  border:1px solid var(--border);
  max-width:460px;width:100%;
  padding:44px 40px;
  display:flex;flex-direction:column;align-items:center;
  gap:22px;text-align:center;
  position:relative;overflow:hidden;
  animation:card-enter .5s cubic-bezier(.4,0,.2,1);
}
@keyframes card-enter{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}

/* top colour band inside card */
.wcard::before{
  content:'';position:absolute;
  top:0;left:0;right:0;height:4px;
  background:linear-gradient(90deg, var(--blue), var(--blue2), #2DD4BF);
}

.wlogo-wrap{
  width:80px;height:80px;position:relative;
  margin-top:8px;
}
.wlogo{
  width:80px;height:80px;border-radius:22px;
  background:linear-gradient(135deg, var(--blue), var(--blue2));
  display:flex;align-items:center;justify-content:center;
  font-size:34px;
  box-shadow:0 8px 24px rgba(18,82,163,0.3);
  position:relative;z-index:1;
  animation:logo-float 4s ease-in-out infinite;
}
@keyframes logo-float{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}

.wbadge{
  position:absolute;bottom:-5px;right:-5px;
  background:var(--green);
  color:#fff;font-size:10px;font-weight:800;
  width:26px;height:26px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  letter-spacing:0;text-transform:uppercase;
  border:2.5px solid var(--white);
  box-shadow:0 2px 8px rgba(0,147,107,0.3);
}

.wtit{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:34px;font-weight:800;
  color:var(--text);letter-spacing:-0.5px;
  line-height:1.1;
}
.wtit .v{color:var(--blue);}

.wsub{
  font-size:14px;color:var(--text2);
  line-height:1.7;max-width:340px;
}

/* Pulse line (EKG style) */
.ekg-wrap{width:100%;height:36px;overflow:hidden;position:relative;}
.ekg-svg{position:absolute;left:0;top:0;width:200%;height:100%;animation:ekg-scroll 3s linear infinite;}
@keyframes ekg-scroll{from{transform:translateX(0);}to{transform:translateX(-50%);}}

.wlangs{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;}
.wlang{
  font-size:12px;font-weight:500;color:var(--text2);
  background:var(--bg);border:1px solid var(--border);
  padding:5px 12px;border-radius:20px;
  transition:all .2s;cursor:default;
}
.wlang:hover{border-color:var(--border2);color:var(--blue);}

.sbtn{
  width:100%;padding:17px;border:none;border-radius:var(--radius2);
  background:linear-gradient(135deg, var(--blue), var(--blue2));
  color:#fff;font-family:'Plus Jakarta Sans',sans-serif;
  font-weight:700;font-size:17px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:10px;
  box-shadow:0 6px 24px rgba(18,82,163,0.35);
  transition:all .2s;position:relative;overflow:hidden;
}
.sbtn::after{
  content:'';position:absolute;
  top:50%;left:50%;width:0;height:0;
  background:rgba(255,255,255,0.15);border-radius:50%;
  transform:translate(-50%,-50%);
  transition:width .4s, height .4s;
}
.sbtn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(18,82,163,0.4);}
.sbtn:active::after{width:300px;height:300px;}
.sbtn:active{transform:translateY(0);}

.wfoot{font-size:11px;color:var(--text3);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANGUAGE DETECT SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sd{background:var(--bg);}

.dcard{
  background:var(--white);
  border-radius:var(--radius);
  box-shadow:var(--shadow2);
  border:1px solid var(--border);
  max-width:420px;width:100%;
  padding:44px 36px;
  display:flex;flex-direction:column;align-items:center;gap:24px;
  text-align:center;
  animation:card-enter .4s cubic-bezier(.4,0,.2,1);
}

.dmic-zone{position:relative;width:140px;height:140px;display:flex;align-items:center;justify-content:center;}
.dring{
  position:absolute;border-radius:50%;
  border:1.5px solid rgba(18,82,163,0.15);
  animation:dring-out 2.5s ease-out infinite;
}
.dring:nth-child(1){inset:0;animation-delay:0s;}
.dring:nth-child(2){inset:-16px;animation-delay:.5s;opacity:0.7;}
.dring:nth-child(3){inset:-32px;animation-delay:1s;opacity:0.4;}
@keyframes dring-out{0%{transform:scale(1);opacity:0.6;}100%{transform:scale(1.25);opacity:0;}}

.dmic.on .dring{border-color:rgba(217,45,32,0.3);}

.dmic{
  width:96px;height:96px;border-radius:50%;
  background:linear-gradient(135deg, var(--blue), var(--blue2));
  border:none;cursor:pointer;font-size:38px;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 8px 28px rgba(18,82,163,0.35);
  transition:all .3s;z-index:1;position:relative;
}
.dmic:hover{transform:scale(1.04);}
.dmic.on{
  background:linear-gradient(135deg, var(--red), #B91C1C);
  box-shadow:0 8px 28px rgba(217,45,32,0.4);
  animation:mic-pulse .85s ease-in-out infinite;
}
@keyframes mic-pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.06);}}

/* Sound wave bars */
.swave{display:flex;align-items:center;gap:3px;height:28px;opacity:0;transition:opacity .3s;}
.swave.on{opacity:1;}
.sb{
  width:3px;border-radius:3px;
  background:linear-gradient(to top, var(--blue), var(--blue2));
  height:4px;animation:sw .9s ease-in-out infinite;
}
.sb:nth-child(1){animation-delay:.0s;}
.sb:nth-child(2){animation-delay:.1s;}
.sb:nth-child(3){animation-delay:.2s;}
.sb:nth-child(4){animation-delay:.3s;}
.sb:nth-child(5){animation-delay:.15s;}
.sb:nth-child(6){animation-delay:.05s;}
.sb:nth-child(7){animation-delay:.25s;}
.sb:nth-child(8){animation-delay:.1s;}
@keyframes sw{0%,100%{height:4px;}50%{height:22px;}}

.dtit{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:21px;font-weight:700;color:var(--text);
}
.dsub{font-size:13px;color:var(--text2);line-height:1.6;}

.lpills{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.lpill{
  padding:7px 15px;border-radius:30px;
  font-size:13px;font-weight:600;
  background:var(--bg);border:1.5px solid var(--border);
  color:var(--text2);cursor:default;
  transition:all .35s cubic-bezier(.4,0,.2,1);
}
.lpill.on{
  background:var(--blue-light);
  border-color:var(--blue2);color:var(--blue);
  transform:scale(1.07);
  box-shadow:0 2px 12px rgba(18,82,163,0.15);
}
.dhint{font-size:13px;color:var(--text3);min-height:18px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INTAKE / CHAT SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#si{flex-direction:column;align-items:center;background:var(--bg);padding:0;}
.iwrap{width:100%;max-width:640px;height:100vh;display:flex;flex-direction:column;}

/* Top bar */
.topbar{
  background:var(--white);
  border-bottom:1px solid var(--border);
  padding:11px 18px;
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
  box-shadow:0 1px 8px rgba(18,82,163,0.06);
}
.tl{display:flex;align-items:center;gap:10px;}
.bbtn{
  width:32px;height:32px;border-radius:8px;
  border:1.5px solid var(--border);background:var(--white);
  cursor:pointer;font-size:14px;color:var(--text2);
  transition:all .2s;
}
.bbtn:hover{border-color:var(--border2);background:var(--blue-light);color:var(--blue);}
.ttit{font-family:'Plus Jakarta Sans',sans-serif;font-weight:700;font-size:15px;color:var(--text);}
.ttit span{color:var(--blue);}
.lbadge{
  display:flex;align-items:center;gap:6px;
  background:var(--blue-light);border:1px solid var(--blue-mid);
  padding:4px 12px;border-radius:20px;
  font-size:11px;font-weight:600;color:var(--blue);
}
.ldot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:dot-blink 2s infinite;}

/* Progress bar */
.prog-bar-wrap{background:var(--white);padding:0 18px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.prog-info{display:flex;justify-content:space-between;align-items:center;padding:8px 0 6px;}
.prog-label{font-size:12px;font-weight:600;color:var(--text2);}
.prog-pct{font-size:12px;font-weight:700;color:var(--blue);}
.prog-track{height:5px;background:var(--border);border-radius:5px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--blue2));border-radius:5px;transition:width .5s cubic-bezier(.4,0,.2,1);width:0%;}

/* Step bar */
.stepbar{
  background:var(--white);padding:12px 18px 10px;
  border-bottom:1px solid var(--border);flex-shrink:0;
}
.srow{display:flex;align-items:flex-start;}
.si-el{
  display:flex;flex-direction:column;align-items:center;flex:1;
  position:relative;gap:5px;
}
.si-el:not(:last-child)::after{
  content:'';position:absolute;
  top:17px;left:calc(50% + 18px);right:calc(-50% + 18px);
  height:2px;background:var(--border);z-index:0;transition:background .4s;
}
.si-el.done:not(:last-child)::after{background:var(--blue);}
.sico{
  width:34px;height:34px;border-radius:50%;
  background:var(--bg);border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;z-index:1;transition:all .3s;
}
.si-el.active .sico{border-color:var(--blue);background:var(--blue-light);box-shadow:0 0 0 4px rgba(18,82,163,0.08);}
.si-el.done .sico{border-color:var(--blue);background:var(--blue);}
.slabel{font-size:9px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.3px;}
.si-el.active .slabel{color:var(--blue);}
.si-el.done .slabel{color:var(--blue);}
.chint{text-align:center;font-size:10px;color:var(--text3);margin-top:4px;}

/* Chat */
.chat{
  flex:1;overflow-y:auto;padding:16px 18px;
  display:flex;flex-direction:column;gap:12px;
  scrollbar-width:thin;scrollbar-color:var(--border) transparent;
}
.chat::-webkit-scrollbar{width:4px;}
.chat::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

.brow{display:flex;gap:8px;align-items:flex-end;animation:msg-in .3s ease;}
@keyframes msg-in{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
.brow.bot{flex-direction:row;}
.brow.usr{flex-direction:row-reverse;}

.av{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.av.bav{background:linear-gradient(135deg,var(--blue),var(--blue2));}
.av.uav{background:var(--blue-light);border:1.5px solid var(--blue-mid);}

.bbl{max-width:78%;padding:11px 15px;border-radius:18px;font-size:14px;line-height:1.55;}
.bbl.bot{
  background:var(--white);border:1px solid var(--border);
  border-bottom-left-radius:4px;color:var(--text);
  box-shadow:0 2px 8px rgba(18,82,163,0.06);
}
.bbl.usr{
  background:linear-gradient(135deg,var(--blue),var(--blue2));
  color:#fff;border-bottom-right-radius:4px;
}
.btime{font-size:10px;opacity:0.45;margin-top:4px;}

.tbbl{
  background:var(--white);border:1px solid var(--border);
  padding:11px 15px;border-radius:18px;border-bottom-left-radius:4px;
  display:flex;gap:4px;align-items:center;
  box-shadow:0 2px 8px rgba(18,82,163,0.06);
}
.td{width:6px;height:6px;border-radius:50%;background:var(--blue);opacity:0.5;animation:tb .9s ease-in-out infinite;}
.td:nth-child(2){animation-delay:.2s;}.td:nth-child(3){animation-delay:.4s;}
@keyframes tb{0%,80%,100%{transform:translateY(0);opacity:0.5;}40%{transform:translateY(-5px);opacity:1;}}

/* Bot area */
.bot-area{
  background:var(--white);border-top:1px solid var(--border);
  padding:18px 18px 26px;flex-shrink:0;
  display:flex;flex-direction:column;align-items:center;gap:11px;
  box-shadow:0 -2px 12px rgba(18,82,163,0.06);
}
.imic-wrap{position:relative;width:80px;height:80px;display:flex;align-items:center;justify-content:center;}
.ir{
  position:absolute;inset:-12px;border-radius:50%;
  border:1.5px solid rgba(18,82,163,0.12);
  animation:imic-ring 2.5s ease-out infinite;
}
@keyframes imic-ring{0%{transform:scale(1);opacity:0.5;}100%{transform:scale(1.35);opacity:0;}}
.imic.on .ir{border-color:rgba(217,45,32,0.2);}

.imic{
  width:70px;height:70px;border-radius:50%;
  background:linear-gradient(135deg,var(--blue),var(--blue2));
  border:none;font-size:26px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 20px rgba(18,82,163,0.35);
  transition:all .25s;z-index:1;position:relative;
}
.imic:hover{transform:scale(1.04);}
.imic.on{
  background:linear-gradient(135deg,var(--red),#B91C1C);
  box-shadow:0 6px 20px rgba(217,45,32,0.4);
  animation:mic-pulse .85s ease-in-out infinite;
}
.mstat{font-size:13px;font-weight:500;color:var(--text2);}
.mstat.on{color:var(--red);font-weight:600;}

.mobbar{
  width:100%;max-width:320px;
  background:var(--bg);border:2px solid var(--blue-mid);
  border-radius:var(--radius3);padding:10px 16px;
  font-family:'Plus Jakarta Sans',monospace;
  font-weight:700;font-size:20px;letter-spacing:4px;
  text-align:center;color:var(--blue);display:none;
}
.mobbar.show{display:block;}

.keypad-wrap{display:none;width:100%;max-width:320px;flex-direction:column;gap:8px;}
.keypad-wrap.show{display:flex;}
.keypad-row{display:flex;gap:8px;justify-content:center;}
.kbtn{
  width:88px;height:48px;border-radius:var(--radius3);
  border:1.5px solid var(--border);background:var(--white);
  font-family:'Plus Jakarta Sans',sans-serif;font-weight:600;font-size:20px;
  cursor:pointer;color:var(--text);transition:all .15s;
  box-shadow:0 2px 6px rgba(18,82,163,0.06);
}
.kbtn:hover{background:var(--blue-light);border-color:var(--blue-mid);color:var(--blue);}
.kbtn:active{transform:scale(0.93);}
.kbtn.del{font-size:15px;color:var(--red);border-color:rgba(217,45,32,0.2);}
.kbtn.del:hover{background:var(--red-light);}
.kbtn.ok{
  background:linear-gradient(135deg,var(--blue),var(--blue2));
  color:#fff;border-color:transparent;
  box-shadow:0 4px 14px rgba(18,82,163,0.3);
}
.kbtn.ok:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(18,82,163,0.4);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRM SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sc{background:var(--bg);padding:16px;overflow-y:auto;align-items:center;justify-content:center;}
.ccard{
  background:var(--white);border-radius:var(--radius);
  border:1px solid var(--border);
  box-shadow:var(--shadow2);
  width:100%;max-width:560px;overflow:hidden;
  margin:auto;
}
.chead{
  background:linear-gradient(135deg,var(--blue-light),#F0F8FF);
  border-bottom:1px solid var(--border);padding:22px 26px;
}
.chead-badge{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--blue);color:#fff;
  font-size:11px;font-weight:700;letter-spacing:0.5px;
  padding:4px 11px;border-radius:20px;text-transform:uppercase;
  margin-bottom:10px;
}
.chead-t{font-family:'Plus Jakarta Sans',sans-serif;font-size:19px;font-weight:700;color:var(--text);}
.chead-s{font-size:13px;color:var(--text2);margin-top:3px;}
.crows{padding:18px 26px;display:flex;flex-direction:column;gap:9px;}
.crow{
  display:flex;align-items:center;justify-content:space-between;
  padding:11px 14px;background:var(--bg);
  border:1px solid var(--border);border-radius:var(--radius3);
  transition:border-color .2s;
}
.crow:hover{border-color:var(--border2);}
.crow-l{font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:1px;}
.crow-v{font-weight:600;font-size:14px;color:var(--text);margin-top:2px;}
.crow-edit{
  background:none;border:1.5px solid var(--border);
  border-radius:7px;padding:5px 11px;
  font-size:12px;color:var(--blue);cursor:pointer;
  font-weight:600;font-family:'Inter',sans-serif;transition:all .2s;
}
.crow-edit:hover{background:var(--blue-light);border-color:var(--blue-mid);}
.clang-msg{text-align:center;padding:0 26px 14px;font-size:13px;color:var(--text2);}
.cbtns{display:flex;gap:11px;padding:0 26px 22px;}
.cbtn{
  flex:1;padding:14px;border-radius:var(--radius2);border:none;
  cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;
  font-weight:700;font-size:14px;transition:all .2s;
}
.cbtn-confirm{
  background:linear-gradient(135deg,var(--green),#00785A);
  color:#fff;box-shadow:0 4px 14px rgba(0,147,107,0.3);
}
.cbtn-confirm:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,147,107,0.4);}
.cbtn-back{
  background:var(--white);color:var(--text2);
  border:1.5px solid var(--border);
}
.cbtn-back:hover{border-color:var(--border2);color:var(--blue);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMERGENCY SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#se{background:linear-gradient(135deg,#FEF0EE,#FFF5F5);}
.e-top-bar{
  position:fixed;top:3px;left:0;right:0;height:5px;
  background:var(--red);
  animation:e-strobe .6s ease-in-out infinite;
}
@keyframes e-strobe{0%,100%{opacity:1;}50%{opacity:0.2;}}
.ecard{
  background:var(--white);border-radius:var(--radius);
  border:2px solid rgba(217,45,32,0.3);
  box-shadow:0 12px 48px rgba(217,45,32,0.2);
  padding:40px 48px;text-align:center;
  display:flex;flex-direction:column;align-items:center;gap:20px;
  max-width:440px;width:100%;
  animation:card-enter .4s ease;
}
.eico{font-size:64px;animation:shk .5s infinite;filter:drop-shadow(0 4px 12px rgba(217,45,32,0.3));}
@keyframes shk{0%,100%{transform:translateX(0);}25%{transform:translateX(-7px);}75%{transform:translateX(7px);}}
.etit{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:clamp(24px,4vw,36px);font-weight:800;color:var(--red);
}
.esub{font-size:15px;color:var(--text2);}
.efl{
  background:var(--red-light);border:2px solid rgba(217,45,32,0.25);
  border-radius:16px;padding:20px 40px;text-align:center;width:100%;
}
.efl-l{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:rgba(217,45,32,0.7);font-weight:700;}
.efl-n{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:80px;font-weight:800;color:var(--red);line-height:1;
}
.efl-w{font-size:14px;color:var(--text2);margin-top:4px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECEIPT SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sr2{
  background:var(--bg);
  flex-direction:column;gap:14px;padding:16px;
  overflow-y:auto;align-items:center;
}

.rcard{
  background:var(--white);border-radius:var(--radius);
  border:1px solid var(--border);box-shadow:var(--shadow2);
  width:100%;max-width:580px;overflow:hidden;
}

/* Receipt header */
.rhead{
  background:linear-gradient(135deg,var(--blue),var(--blue2));
  padding:20px 26px;
  display:flex;align-items:center;justify-content:space-between;
}
.rlogo{font-family:'Plus Jakarta Sans',sans-serif;font-size:20px;font-weight:800;color:#fff;}
.rlogo span{color:#93C5FD;}
.rreg{text-align:right;}
.rreg-l{font-size:10px;letter-spacing:1px;color:rgba(255,255,255,0.65);text-transform:uppercase;font-weight:600;}
.rreg strong{
  display:block;font-size:13px;font-weight:700;
  color:#fff;margin-top:3px;letter-spacing:1px;
  font-family:'Plus Jakarta Sans',monospace;
}

/* Dept section */
.rdrow{
  background:var(--blue-light);
  border-bottom:1px solid var(--border);
  padding:18px 26px;
  display:flex;align-items:center;justify-content:space-between;
}
.rdname{font-family:'Plus Jakarta Sans',sans-serif;font-size:21px;font-weight:700;color:var(--blue);}
.rddoc{font-size:12px;color:var(--text2);margin-top:3px;}
.rflb{text-align:right;}
.rfll{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);font-weight:600;}
.rfln{
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:72px;font-weight:800;color:var(--blue);line-height:0.9;
}
.rflw{font-size:11px;color:var(--text2);margin-top:2px;}

/* Token number â€” new enhancement */
.rtoken{
  background:linear-gradient(135deg,var(--green-light),#F0FAF6);
  border-bottom:1px solid var(--border);
  padding:12px 26px;
  display:flex;align-items:center;justify-content:space-between;
}
.rtoken-l{font-size:11px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:1px;}
.rtoken-n{font-family:'Plus Jakarta Sans',sans-serif;font-size:22px;font-weight:800;color:var(--green);}
.rtoken-w{font-size:12px;color:var(--text2);}

.rbody{padding:14px 26px;display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.rf{display:flex;flex-direction:column;gap:4px;}
.rf.full{grid-column:1/-1;}
.rfl2{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);font-weight:600;}
.rfv{font-weight:600;font-size:14px;color:var(--text);}

.spills{display:flex;flex-wrap:wrap;gap:5px;margin-top:4px;}
.spill{
  background:var(--blue-light);color:var(--blue);
  font-size:12px;font-weight:600;
  padding:3px 11px;border-radius:18px;
  border:1px solid var(--blue-mid);
}

.rfoot{
  padding:11px 26px;background:var(--bg2);
  border-top:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
}
.rtime{font-size:11px;color:var(--text3);}
.pb{padding:4px 13px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;}
.pb.norm{background:var(--green-light);color:var(--green);border:1px solid rgba(0,147,107,0.2);}
.pb.hi{background:var(--red-light);color:var(--red);border:1px solid rgba(217,45,32,0.2);}

/* Action buttons */
.ract{display:flex;gap:10px;width:100%;max-width:580px;}
.abtn{
  flex:1;padding:14px;border-radius:var(--radius2);border:none;
  cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;
  font-weight:700;font-size:14px;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .2s;
}
.aprint{
  background:var(--white);color:var(--blue);
  border:2px solid var(--blue-mid);
  box-shadow:var(--shadow);
}
.aprint:hover{background:var(--blue-light);}
.adl{
  background:linear-gradient(135deg,var(--blue),var(--blue2));
  color:#fff;box-shadow:0 4px 14px rgba(18,82,163,0.3);
}
.adl:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(18,82,163,0.4);}

.cdwrap{width:100%;max-width:580px;}
.cdi{display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-bottom:5px;}
.cdt{height:4px;background:var(--border);border-radius:4px;overflow:hidden;}
.cdf{height:100%;background:linear-gradient(90deg,var(--blue),var(--blue2));border-radius:4px;transition:width 1s linear;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAY & TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ovl{
  position:fixed;inset:0;z-index:200;
  background:rgba(238,244,251,0.88);
  backdrop-filter:blur(6px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;
  opacity:0;pointer-events:none;transition:opacity .3s;
}
.ovl.show{opacity:1;pointer-events:all;}
.spin{width:48px;height:48px;border-radius:50%;border:4px solid var(--border);border-top-color:var(--blue);animation:sp .75s linear infinite;}
@keyframes sp{to{transform:rotate(360deg);}}
.ovt{font-family:'Plus Jakarta Sans',sans-serif;font-weight:600;font-size:15px;color:var(--text2);}

.toast{
  position:fixed;bottom:22px;left:50%;
  transform:translateX(-50%) translateY(10px);
  background:var(--text);color:#fff;
  padding:10px 22px;border-radius:30px;
  font-size:13px;font-weight:500;z-index:300;
  opacity:0;transition:all .3s;pointer-events:none;
  white-space:nowrap;box-shadow:0 4px 20px rgba(15,33,55,0.3);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print{
  body{background:#fff !important;}
  body::before{display:none;}
  body *{visibility:hidden;}
  .rcard,.rcard *{visibility:visible;}
  .rcard{position:fixed;inset:0;width:100%;box-shadow:none;border-radius:0;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â• WELCOME â•â•â•â•â•â• -->
<div class="screen active" id="sw">
  <div class="wcard">
    <div class="wlogo-wrap">
      <div class="wlogo">ğŸ¥</div>

    </div>
    <div class="wtit"><span class="v">Voice</span>Byte</div>

    <!-- EKG line -->
    <div class="ekg-wrap">
      <svg class="ekg-svg" viewBox="0 0 800 36" preserveAspectRatio="none">
        <polyline points="0,18 80,18 100,18 110,4 120,32 130,18 140,18 220,18 240,18 250,4 260,32 270,18 280,18 360,18 380,18 390,4 400,32 410,18 420,18 500,18 520,18 530,4 540,32 550,18 560,18 640,18 660,18 670,4 680,32 690,18 700,18 800,18"
          fill="none" stroke="#1A6FD4" stroke-width="1.5" opacity="0.35"/>
      </svg>
    </div>

    <p class="wsub">AI-powered hospital self-registration.<br>Speak in your language â€” we understand you.</p>

    <div class="wlangs">
      <span class="wlang">English</span>
      <span class="wlang">à¤¹à¤¿à¤‚à¤¦à¥€</span>
      <span class="wlang">à°¤à±†à°²à±à°—à±</span>
      <span class="wlang">à®¤à®®à®¿à®´à¯</span>
      <span class="wlang">à´®à´²à´¯à´¾à´³à´‚</span>
    </div>

    <button class="sbtn" id="startBtn">ğŸ¤ &nbsp;Start Voice Registration</button>
    <p class="wfoot">City General Hospital &nbsp;Â·&nbsp; Powered by VoiceByte AI</p>
  </div>
</div>

<!-- â•â•â•â•â•â• DETECT LANGUAGE â•â•â•â•â•â• -->
<div class="screen" id="sd">
  <div class="dcard">
    <div class="dmic-zone">
      <div class="dring"></div>
      <div class="dring"></div>
      <div class="dring"></div>
      <button class="dmic" id="dmic">ğŸ¤</button>
    </div>
    <div class="swave" id="soundwave">
      <div class="sb"></div><div class="sb"></div><div class="sb"></div>
      <div class="sb"></div><div class="sb"></div><div class="sb"></div>
      <div class="sb"></div><div class="sb"></div>
    </div>
    <div class="dtit">Speak a few words</div>
    <p class="dsub">Say anything in your language.<br>We detect it automatically â€” no selection needed.</p>
    <div class="lpills">
      <span class="lpill" id="lp-en">English</span>
      <span class="lpill" id="lp-hi">à¤¹à¤¿à¤‚à¤¦à¥€</span>
      <span class="lpill" id="lp-te">à°¤à±†à°²à±à°—à±</span>
      <span class="lpill" id="lp-ta">à®¤à®®à®¿à®´à¯</span>
      <span class="lpill" id="lp-ml">à´®à´²à´¯à´¾à´³à´‚</span>
    </div>
    <p class="dhint" id="dhint" style="display:none"></p>
  </div>
</div>

<!-- â•â•â•â•â•â• INTAKE CHAT â•â•â•â•â•â• -->
<div class="screen" id="si">
  <div class="iwrap">
    <div class="topbar">
      <div class="tl">
        <button class="bbtn" onclick="resetAll()">â†</button>
        <span class="ttit"><span>Voice</span>Byte</span>
      </div>
      <div class="lbadge"><div class="ldot"></div><span id="langLbl">English</span></div>
    </div>
    <div class="prog-bar-wrap">
      <div class="prog-info">
        <span class="prog-label" id="prog-label">Step 1 of 5</span>
        <span class="prog-pct" id="prog-pct">0%</span>
      </div>
      <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
    </div>
    <div class="stepbar">
      <div class="srow">
        <div class="si-el active" id="si-1">
          <div class="sico">ğŸ‘¤</div>
          <div class="slabel">Name</div>
        </div>
        <div class="si-el" id="si-2">
          <div class="sico">ğŸ‚</div>
          <div class="slabel">Age</div>
        </div>
        <div class="si-el" id="si-3">
          <div class="sico">ğŸ“±</div>
          <div class="slabel">Mobile</div>
        </div>
        <div class="si-el" id="si-4">
          <div class="sico">ğŸ¥</div>
          <div class="slabel">Symptoms</div>
        </div>
        <div class="si-el" id="si-5">
          <div class="sico">ğŸ“…</div>
          <div class="slabel">Duration</div>
        </div>
      </div>
      <div class="chint">âœ… Tap any completed step to correct it</div>
    </div>
    <div class="chat" id="chat"></div>
    <div class="bot-area">
      <div class="imic-wrap">
        <button class="imic" id="mbtn"><div class="ir"></div>ğŸ¤</button>
      </div>
      <span class="mstat" id="mstat">ğŸ‘† Tap mic to speak</span>
      <div class="mobbar" id="mobBar">_ _ _ _ _ _ _ _ _ _</div>
      <div class="keypad-wrap" id="keypad">
        <div class="keypad-row">
          <button class="kbtn" onclick="kp('1')">1</button>
          <button class="kbtn" onclick="kp('2')">2</button>
          <button class="kbtn" onclick="kp('3')">3</button>
        </div>
        <div class="keypad-row">
          <button class="kbtn" onclick="kp('4')">4</button>
          <button class="kbtn" onclick="kp('5')">5</button>
          <button class="kbtn" onclick="kp('6')">6</button>
        </div>
        <div class="keypad-row">
          <button class="kbtn" onclick="kp('7')">7</button>
          <button class="kbtn" onclick="kp('8')">8</button>
          <button class="kbtn" onclick="kp('9')">9</button>
        </div>
        <div class="keypad-row">
          <button class="kbtn del" onclick="kpDel()">âŒ« Del</button>
          <button class="kbtn" onclick="kp('0')">0</button>
          <button class="kbtn ok" onclick="kpOk()">âœ“ OK</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• CONFIRM â•â•â•â•â•â• -->
<div class="screen" id="sc">
  <div style="width:100%;max-width:520px;margin:auto;">
    <div class="ccard">
      <div class="chead">
        <div class="chead-badge">ğŸ“‹ Review Details</div>
        <div class="chead-t" id="confirm-title">Please confirm your details</div>
        <div class="chead-s" id="confirm-sub">Check and tap Edit to correct anything</div>
      </div>
      <div class="crows" id="confirmRows"></div>
      <div class="clang-msg" id="confirm-lang-msg"></div>
      <div class="cbtns">
        <button class="cbtn cbtn-back" onclick="goBackToIntake()">âœï¸ Edit</button>
        <button class="cbtn cbtn-confirm" id="confirmBtn">âœ… Confirm &amp; Proceed</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• EMERGENCY â•â•â•â•â•â• -->
<div class="screen" id="se">
  <div class="e-top-bar"></div>
  <div class="ecard">
    <div class="eico">ğŸš¨</div>
    <div class="etit">Emergency Detected!</div>
    <div class="esub">Staff have been alerted. Please stay calm.</div>
    <div class="efl">
      <div class="efl-l">Go immediately to floor</div>
      <div class="efl-n">0</div>
      <div class="efl-w">Ground Floor Â· Emergency Ward</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• RECEIPT â•â•â•â•â•â• -->
<div class="screen" id="sr2">
  <div class="rcard" id="rcard">
    <div class="rhead">
      <div class="rlogo">Voice<span>Byte</span></div>
      <div class="rreg">
        <div class="rreg-l">Registration No.</div>
        <strong id="r-reg">â€”</strong>
      </div>
    </div>
    <div class="rdrow">
      <div>
        <div class="rdname" id="r-dept">â€”</div>
        <div class="rddoc" id="r-doc">â€”</div>
      </div>
      <div class="rflb">
        <div class="rfll">Floor</div>
        <div class="rfln" id="r-fl">1</div>
        <div class="rflw" id="r-flw">First Floor</div>
      </div>
    </div>
    <!-- Multiple departments section -->
    <div id="r-multidept" style="display:none;margin:10px 0;padding:10px;background:#f0f4ff;border-radius:10px;border-left:4px solid #3B82F6;">
      <div style="font-size:11px;font-weight:700;color:#1252A3;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">ğŸ“‹ Also Visit</div>
      <div id="r-multidept-list"></div>
    </div>
    <div class="rtoken">
      <div>
        <div class="rtoken-l">ğŸ« Token Number</div>
        <div class="rtoken-n" id="r-token">â€”</div>
      </div>
      <div class="rtoken-w" id="r-wait">Please proceed to the department</div>
    </div>
    <div class="rbody">
      <div class="rf"><div class="rfl2">Patient Name</div><div class="rfv" id="r-name">â€”</div></div>
      <div class="rf"><div class="rfl2">Age</div><div class="rfv" id="r-age">â€”</div></div>
      <div class="rf"><div class="rfl2">Mobile</div><div class="rfv" id="r-mob">â€”</div></div>
      <div class="rf"><div class="rfl2">Language</div><div class="rfv" id="r-lang">â€”</div></div>
      <div class="rf full"><div class="rfl2">Symptoms</div><div class="spills" id="r-sym"></div></div>
      <div class="rf full"><div class="rfl2">Duration</div><div class="rfv" id="r-days">â€”</div></div>
    </div>
    <div class="rfoot">
      <div class="rtime" id="r-time">â€”</div>
      <div class="pb norm" id="r-pri">Normal Priority</div>
    </div>
  </div>
  <div class="ract">
    <button class="abtn aprint" onclick="doPrint()">ğŸ–¨ï¸ &nbsp;Print Receipt</button>
    <button class="abtn adl" onclick="doDownload()">â¬‡ï¸ &nbsp;Download</button>
  </div>
  <div class="cdwrap">
    <div class="cdi">
      <span id="cdmsg">Session expires after print/download</span>
      <span id="cdnum"></span>
    </div>
    <div class="cdt"><div class="cdf" id="cdf" style="width:0%"></div></div>
  </div>
</div>

<!-- Overlay + Toast -->
<div class="ovl" id="ovl"><div class="spin"></div><div class="ovt" id="ovmsg">Processingâ€¦</div></div>
<div class="toast" id="toast"></div>

<script>
// Auto-detect backend URL â€” works both locally and on Render
const BACKEND = (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost')
  ? 'http://127.0.0.1:5000'
  : window.location.origin;  // On Render: uses same server URL automatically

// Soundwave toggle
function setSoundwave(on){ document.getElementById('soundwave').classList.toggle('on', on); }

// Progress bar update
function updateProgress(idx){
  const pct = Math.round((idx / 5) * 100);
  document.getElementById('prog-fill').style.width = pct + '%';
  document.getElementById('prog-pct').textContent = pct + '%';
  document.getElementById('prog-label').textContent = idx < 5
    ? 'Step ' + (idx + 1) + ' of 5'
    : 'All steps complete';
}

// â”€â”€ MULTILINGUAL PHRASES â”€â”€
const P = {
  English:{
    q:['What is your full name?','How old are you?','Please say your 10-digit mobile number digit by digit.','Please describe your health problem or symptoms.','How many days have you had this problem?'],
    retry:'Sorry, I did not understand. Please tap the mic and speak again.',
    confirm_title:'Please confirm your details',
    confirm_sub:'Check below and tap Edit to correct anything',
    confirm_msg:'If all details are correct, tap Confirm to proceed.',
    confirm_btn:'Confirm and Proceed',
    labels:['Name','Age','Mobile','Symptoms','Duration'],
    floor_msg:'Please go to floor number '
  },
  Hindi:{
    q:['à¤†à¤ªà¤•à¤¾ à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤® à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ?','à¤†à¤ªà¤•à¥€ à¤‰à¤®à¥à¤° à¤•à¥à¤¯à¤¾ à¤¹à¥ˆ?','à¤•à¥ƒà¤ªà¤¯à¤¾ à¤…à¤ªà¤¨à¤¾ 10 à¤…à¤‚à¤•à¥‹à¤‚ à¤•à¤¾ à¤®à¥‹à¤¬à¤¾à¤‡à¤² à¤¨à¤‚à¤¬à¤° à¤¬à¥‹à¤²à¥‡à¤‚à¥¤','à¤…à¤ªà¤¨à¥€ à¤¬à¥€à¤®à¤¾à¤°à¥€ à¤¯à¤¾ à¤²à¤•à¥à¤·à¤£ à¤¬à¤¤à¤¾à¤à¤‚à¥¤','à¤•à¤¿à¤¤à¤¨à¥‡ à¤¦à¤¿à¤¨à¥‹à¤‚ à¤¸à¥‡ à¤¯à¤¹ à¤¸à¤®à¤¸à¥à¤¯à¤¾ à¤¹à¥ˆ?'],
    retry:'à¤®à¤¾à¤« à¤•à¤°à¥‡à¤‚, à¤¸à¤®à¤ à¤¨à¤¹à¥€à¤‚ à¤†à¤¯à¤¾à¥¤ à¤®à¤¾à¤‡à¤• à¤¦à¤¬à¤¾à¤à¤‚ à¤”à¤° à¤«à¤¿à¤° à¤¬à¥‹à¤²à¥‡à¤‚à¥¤',
    confirm_title:'à¤•à¥ƒà¤ªà¤¯à¤¾ à¤…à¤ªà¤¨à¥‡ à¤µà¤¿à¤µà¤°à¤£ à¤•à¥€ à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤•à¤°à¥‡à¤‚',
    confirm_sub:'à¤¨à¥€à¤šà¥‡ à¤¦à¥‡à¤–à¥‡à¤‚ à¤”à¤° à¤—à¤²à¤¤ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤¸à¥à¤§à¤¾à¤°à¥‡à¤‚',
    confirm_msg:'à¤…à¤—à¤° à¤¸à¤¬ à¤¸à¤¹à¥€ à¤¹à¥ˆ à¤¤à¥‹ à¤†à¤—à¥‡ à¤¬à¤¢à¤¼à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤•à¤°à¥‡à¤‚à¥¤',
    confirm_btn:'à¤ªà¥à¤·à¥à¤Ÿà¤¿ à¤•à¤°à¥‡à¤‚',
    labels:['à¤¨à¤¾à¤®','à¤‰à¤®à¥à¤°','à¤®à¥‹à¤¬à¤¾à¤‡à¤²','à¤²à¤•à¥à¤·à¤£','à¤…à¤µà¤§à¤¿'],
    floor_msg:'à¤•à¥ƒà¤ªà¤¯à¤¾ à¤®à¤‚à¤œà¤¿à¤² à¤¨à¤‚à¤¬à¤° à¤œà¤¾à¤à¤‚ '
  },
  Telugu:{
    q:['à°®à±€ à°ªà±‚à°°à±à°¤à°¿ à°ªà±‡à°°à± à°šà±†à°ªà±à°ªà°‚à°¡à°¿.','à°®à±€ à°µà°¯à°¸à± à°à°‚à°¤?','à°®à±€ 10 à°…à°‚à°•à±†à°² à°®à±Šà°¬à±ˆà°²à± à°¨à°‚à°¬à°°à± à°šà±†à°ªà±à°ªà°‚à°¡à°¿.','à°®à±€ à°…à°¨à°¾à°°à±‹à°—à±à°¯à°‚ à°²à±‡à°¦à°¾ à°²à°•à±à°·à°£à°¾à°²à± à°šà±†à°ªà±à°ªà°‚à°¡à°¿.','à°à°¨à±à°¨à°¿ à°°à±‹à°œà±à°²à±à°—à°¾ à°ˆ à°¸à°®à°¸à±à°¯ à°‰à°‚à°¦à°¿?'],
    retry:'à°•à±à°·à°®à°¿à°‚à°šà°‚à°¡à°¿, à°…à°°à±à°¥à°‚ à°•à°¾à°²à±‡à°¦à±. à°®à±ˆà°•à± à°¨à±Šà°•à±à°•à°¿ à°®à°³à±à°³à±€ à°šà±†à°ªà±à°ªà°‚à°¡à°¿.',
    confirm_title:'à°¦à°¯à°šà±‡à°¸à°¿ à°®à±€ à°µà°¿à°µà°°à°¾à°²à± à°¨à°¿à°°à±à°§à°¾à°°à°¿à°‚à°šà°‚à°¡à°¿',
    confirm_sub:'à°¦à°¿à°—à±à°µ à°šà±‚à°¸à°¿ à°¤à°ªà±à°ªà±à°²à± à°¸à°°à°¿à°šà±‡à°¯à°‚à°¡à°¿',
    confirm_msg:'à°…à°¨à±à°¨à±€ à°¸à°°à±ˆà°¨à°µà±ˆà°¤à±‡ à°¨à°¿à°°à±à°§à°¾à°°à°¿à°‚à°šà± à°¨à±Šà°•à±à°•à°‚à°¡à°¿.',
    confirm_btn:'à°¨à°¿à°°à±à°§à°¾à°°à°¿à°‚à°šà±',
    labels:['à°ªà±‡à°°à±','à°µà°¯à°¸à±','à°®à±Šà°¬à±ˆà°²à±','à°²à°•à±à°·à°£à°¾à°²à±','à°µà±à°¯à°µà°§à°¿'],
    floor_msg:'à°¦à°¯à°šà±‡à°¸à°¿ à°…à°‚à°¤à°¸à±à°¤à± à°¨à°‚à°¬à°°à± à°•à°¿ à°µà±†à°³à±à°³à°‚à°¡à°¿ '
  },
  Tamil:{
    q:['à®‰à®™à¯à®•à®³à¯ à®®à¯à®´à¯ à®ªà¯†à®¯à®°à¯ à®šà¯Šà®²à¯à®²à¯à®™à¯à®•à®³à¯.','à®‰à®™à¯à®•à®³à¯ à®µà®¯à®¤à¯ à®à®©à¯à®©?','à®‰à®™à¯à®•à®³à¯ 10 à®‡à®²à®•à¯à®• à®®à¯Šà®ªà¯ˆà®²à¯ à®à®£à¯ à®šà¯Šà®²à¯à®²à¯à®™à¯à®•à®³à¯.','à®‰à®™à¯à®•à®³à¯ à®‰à®Ÿà®²à¯à®¨à®² à®ªà®¿à®°à®šà¯à®šà®©à¯ˆ à®…à®²à¯à®²à®¤à¯ à®…à®±à®¿à®•à¯à®±à®¿à®•à®³à¯ˆ à®šà¯Šà®²à¯à®²à¯à®™à¯à®•à®³à¯.','à®à®¤à¯à®¤à®©à¯ˆ à®¨à®¾à®Ÿà¯à®•à®³à®¾à®• à®‡à®¨à¯à®¤ à®ªà®¿à®°à®šà¯à®šà®©à¯ˆ à®‡à®°à¯à®•à¯à®•à®¿à®±à®¤à¯?'],
    retry:'à®®à®©à¯à®©à®¿à®•à¯à®•à®µà¯à®®à¯, à®ªà¯à®°à®¿à®¯à®µà®¿à®²à¯à®²à¯ˆ. à®®à¯ˆà®•à¯à®•à¯ˆ à®…à®´à¯à®¤à¯à®¤à®¿ à®®à¯€à®£à¯à®Ÿà¯à®®à¯ à®šà¯Šà®²à¯à®²à¯à®™à¯à®•à®³à¯.',
    confirm_title:'à®‰à®™à¯à®•à®³à¯ à®µà®¿à®µà®°à®™à¯à®•à®³à¯ˆ à®‰à®±à¯à®¤à®¿à®ªà¯à®ªà®Ÿà¯à®¤à¯à®¤à¯à®™à¯à®•à®³à¯',
    confirm_sub:'à®•à¯€à®´à¯‡ à®ªà®¾à®°à¯à®¤à¯à®¤à¯ à®¤à®µà®±à¯à®•à®³à¯ˆ à®¤à®¿à®°à¯à®¤à¯à®¤à¯à®™à¯à®•à®³à¯',
    confirm_msg:'à®…à®©à¯ˆà®¤à¯à®¤à¯à®®à¯ à®šà®°à®¿à®¯à®¾à®• à®‡à®°à¯à®¨à¯à®¤à®¾à®²à¯ à®‰à®±à¯à®¤à®¿à®ªà¯à®ªà®Ÿà¯à®¤à¯à®¤à¯à®™à¯à®•à®³à¯.',
    confirm_btn:'à®‰à®±à¯à®¤à®¿à®ªà¯à®ªà®Ÿà¯à®¤à¯à®¤à¯',
    labels:['à®ªà¯†à®¯à®°à¯','à®µà®¯à®¤à¯','à®®à¯Šà®ªà¯ˆà®²à¯','à®…à®±à®¿à®•à¯à®±à®¿à®•à®³à¯','à®•à®¾à®²à®®à¯'],
    floor_msg:'à®¤à®¯à®µà¯à®šà¯†à®¯à¯à®¤à¯ à®¤à®³à®®à¯ à®à®£à¯à®£à¯à®•à¯à®•à¯ à®šà¯†à®²à¯à®²à¯à®™à¯à®•à®³à¯ '
  },
  Malayalam:{
    q:['à´¨à´¿à´™àµà´™à´³àµà´Ÿàµ† à´ªàµ‚àµ¼à´£àµà´£ à´ªàµ‡à´°àµ à´ªà´±à´¯àµ‚.','à´¨à´¿à´™àµà´™àµ¾à´•àµà´•àµ à´à´¤àµà´° à´µà´¯à´¸àµà´¸àµ?','à´¨à´¿à´™àµà´™à´³àµà´Ÿàµ† 10 à´…à´•àµà´• à´®àµŠà´¬àµˆàµ½ à´¨à´®àµà´ªàµ¼ à´“à´°àµ‹ à´…à´•àµà´•à´®à´¾à´¯à´¿ à´ªà´±à´¯àµ‚.','à´¨à´¿à´™àµà´™à´³àµà´Ÿàµ† à´†à´°àµ‹à´—àµà´¯ à´ªàµà´°à´¶àµà´¨à´‚ à´…à´²àµà´²àµ†à´™àµà´•à´¿àµ½ à´²à´•àµà´·à´£à´™àµà´™àµ¾ à´ªà´±à´¯àµ‚.','à´à´¤àµà´° à´¦à´¿à´µà´¸à´®à´¾à´¯à´¿ à´ˆ à´ªàµà´°à´¶àµà´¨à´‚ à´‰à´£àµà´Ÿàµ?'],
    retry:'à´•àµà´·à´®à´¿à´•àµà´•àµ‚, à´®à´¨à´¸àµà´¸à´¿à´²à´¾à´¯à´¿à´²àµà´². à´®àµˆà´•àµà´•àµ à´Ÿà´¾à´ªàµà´ªàµ à´šàµ†à´¯àµà´¤àµ à´µàµ€à´£àµà´Ÿàµà´‚ à´ªà´±à´¯àµ‚.',
    confirm_title:'à´¨à´¿à´™àµà´™à´³àµà´Ÿàµ† à´µà´¿à´µà´°à´™àµà´™àµ¾ à´¸àµà´¥à´¿à´°àµ€à´•à´°à´¿à´•àµà´•àµ‚',
    confirm_sub:'à´¤à´¾à´´àµ† à´ªà´°à´¿à´¶àµ‹à´§à´¿à´šàµà´šàµ à´¤àµ†à´±àµà´±àµà´•àµ¾ à´¤à´¿à´°àµà´¤àµà´¤àµ‚',
    confirm_msg:'à´à´²àµà´²à´¾à´‚ à´¶à´°à´¿à´¯à´¾à´£àµ†à´™àµà´•à´¿àµ½ à´¸àµà´¥à´¿à´°àµ€à´•à´°à´¿à´•àµà´•àµ‚.',
    confirm_btn:'à´¸àµà´¥à´¿à´°àµ€à´•à´°à´¿à´•àµà´•àµ‚',
    labels:['à´ªàµ‡à´°àµ','à´ªàµà´°à´¾à´¯à´‚','à´®àµŠà´¬àµˆàµ½','à´²à´•àµà´·à´£à´™àµà´™àµ¾','à´¦àµˆàµ¼à´˜àµà´¯à´‚'],
    floor_msg:'à´¦à´¯à´µà´¾à´¯à´¿ à´¨à´¿à´² à´¨à´®àµà´ªàµ¼ à´²àµ‡à´•àµà´•àµ à´ªàµ‹à´•àµ‚ '
  }
};
function ph(){ return P[S.lang]||P.English; }

const KEYS  = ['name','age','mobile','symptoms','days'];
const SICOS = ['ğŸ‘¤','ğŸ‚','ğŸ“±','ğŸ¥','ğŸ“…'];
const SLBLS = ['Name','Age','Mobile','Symptoms','Duration'];

const W2D = {
  zero:'0',one:'1',two:'2',three:'3',four:'4',five:'5',six:'6',seven:'7',eight:'8',nine:'9',
  shunya:'0',ek:'1',do:'2',teen:'3',char:'4',paanch:'5',chhe:'6',saat:'7',aath:'8',nau:'9',
  sunna:'0',okati:'1',rendu:'2',madu:'3',nalugu:'4',ayidu:'5',aaru:'6',edu:'7',enimidi:'8',tommidi:'9'
};
function digits(t){
  let s=t.toLowerCase();
  for(const[w,d] of Object.entries(W2D)) s=s.replace(new RegExp('\\b'+w+'\\b','g'),d);
  return s.replace(/[^0-9]/g,'');
}

const S={lang:'English',step:0,name:'',age:'',mobile:'',symptoms:'',days:'',
  department:'',floor:1,floorWord:'',doctor:'',keywords:[],emergency:false,reg:'',all_departments:[]};

// â”€â”€ UTILS â”€â”€
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function overlay(on,msg){document.getElementById('ovl').classList.toggle('show',on);if(msg)document.getElementById('ovmsg').textContent=msg;}
function toast(m,d=3000){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),d);}
function ts(){const d=new Date();return d.getHours()+':'+String(d.getMinutes()).padStart(2,'0')+' '+(d.getHours()<12?'am':'pm');}

// â”€â”€ CHAT â”€â”€
function botMsg(html,typing=false){
  const c=document.getElementById('chat');
  if(typing){
    const r=document.createElement('div');r.className='brow bot';r.id='trow';
    r.innerHTML='<div class="av bav">ğŸ¤–</div><div class="tbbl"><div class="td"></div><div class="td"></div><div class="td"></div></div>';
    c.appendChild(r);c.scrollTop=c.scrollHeight;return;
  }
  const r=document.createElement('div');r.className='brow bot';
  r.innerHTML='<div class="av bav">ğŸ¤–</div><div class="bbl bot">'+html+'<div class="btime">'+ts()+'</div></div>';
  c.appendChild(r);c.scrollTop=c.scrollHeight;
}
function rmTyping(){const e=document.getElementById('trow');if(e)e.remove();}
function userMsg(t){
  const c=document.getElementById('chat');
  const r=document.createElement('div');r.className='brow usr';
  r.innerHTML='<div class="bbl usr">'+t+'<div class="btime">'+ts()+'</div></div><div class="av uav">ğŸ‘¤</div>';
  c.appendChild(r);c.scrollTop=c.scrollHeight;
}

// â”€â”€ TTS â”€â”€
let curAudio=null;
// â”€â”€ TTS using browser SpeechSynthesis (works on HTTPS, no autoplay block) â”€â”€
const LANG_FALLBACKS = {
  'Hindi':    ['hi-IN','hi','en-IN'],
  'Tamil':    ['ta-IN','ta','en-IN'],
  'Malayalam':['ml-IN','ml','en-IN'],
  'English':  ['en-IN','en-US','en-GB']
};
// Telugu uses gTTS backend â€” browser has no reliable te-IN voice
const USE_GTTS = ['Telugu'];

let curAudioEl = null; // for gTTS audio element

function getBestVoice(lang){
  const voices = window.speechSynthesis.getVoices();
  const codes  = LANG_FALLBACKS[lang] || ['en-IN'];
  for(const code of codes){
    const v = voices.find(function(v2){
      return v2.lang === code || v2.lang.startsWith(code.split('-')[0]);
    });
    if(v) return {voice:v, langCode:v.lang};
  }
  return {voice:null, langCode:'en-IN'};
}

function speak(text, lang, cb){
  if(!text){if(cb)cb();return;}
  stopAudio();
  let _done = false;
  const done = function(){ if(_done)return; _done=true; if(cb)cb(); };

  if(USE_GTTS.indexOf(lang) !== -1){
    // Use gTTS backend for Telugu
    fetch(BACKEND+'/tts',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text:text,lang:lang})})
    .then(function(r){return r.blob();})
    .then(function(blob){
      const url = URL.createObjectURL(blob);
      const a   = new Audio(url);
      curAudioEl = a;
      a.onended = function(){ URL.revokeObjectURL(url); curAudioEl=null; done(); };
      a.onerror = function(){ URL.revokeObjectURL(url); curAudioEl=null; done(); };
      a.play().catch(function(){ curAudioEl=null; done(); });
    })
    .catch(function(){ done(); });
    return;
  }

  // Browser SpeechSynthesis for other languages
  if(!window.speechSynthesis){done();return;}
  const utt  = new SpeechSynthesisUtterance(text);
  const best = getBestVoice(lang);
  if(best.voice) utt.voice = best.voice;
  utt.lang   = best.langCode;
  utt.rate   = 0.9;
  utt.pitch  = 1.0;
  utt.volume = 1.0;
  utt.onend   = done;
  utt.onerror = done;
  curAudio = utt;
  setTimeout(function(){ window.speechSynthesis.speak(utt); }, 150);
}

function stopAudio(){
  if(window.speechSynthesis) window.speechSynthesis.cancel();
  if(curAudioEl){ curAudioEl.pause(); curAudioEl=null; }
  curAudio = null;
}

// â”€â”€ STEP UI â”€â”€
function stepUI(idx,cls){
  const el=document.getElementById('si-'+(idx+1));if(!el)return;
  el.className='si-el '+cls;
  if(cls==='done'){el.querySelector('.sico').textContent='âœ…';el.style.cursor='pointer';el.onclick=()=>reaskStep(idx);}
  else{el.style.cursor='';el.onclick=null;}
  // Update progress
  const done = document.querySelectorAll('.si-el.done').length;
  updateProgress(cls==='done' ? done : idx);
}

// â”€â”€ MIC STATUS â”€â”€
function micReady(){document.getElementById('mbtn').classList.remove('on');const s=document.getElementById('mstat');s.className='mstat';s.textContent='ğŸ‘† Tap mic to speak';}
function micOn(){document.getElementById('mbtn').classList.add('on');const s=document.getElementById('mstat');s.className='mstat on';s.textContent='ğŸ”´ Listeningâ€¦ speak now';}
function micBusy(){document.getElementById('mbtn').classList.remove('on');const s=document.getElementById('mstat');s.className='mstat';s.textContent='â³ Processingâ€¦';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETECT LANGUAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let detectSR=null;
function startDetect(){
  show('sd');
  setTimeout(()=>listenDetect(),400);
  document.getElementById('dmic').onclick=()=>{stopAudio();listenDetect();};
}
function listenDetect(){
  if(detectSR){try{detectSR.abort();}catch(e){}detectSR=null;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('âŒ Please use Google Chrome');return;}
  const sr=new SR();detectSR=sr;
  sr.lang='en-IN';sr.continuous=true;sr.interimResults=true;
  const btn=document.getElementById('dmic'),hint=document.getElementById('dhint');
  btn.classList.add('on');setSoundwave(true);
  let final='',timer=null;
  sr.onresult=(e)=>{
    let f='',i='';
    for(let x=e.resultIndex;x<e.results.length;x++){
      if(e.results[x].isFinal)f+=e.results[x][0].transcript;
      else i+=e.results[x][0].transcript;
    }
    if(i){}
    if(f){final+=' '+f;clearTimeout(timer);timer=setTimeout(()=>{try{sr.stop();}catch(e){}},1200);}
  };
  sr.onend=async()=>{
    btn.classList.remove('on');setSoundwave(false);clearTimeout(timer);
    const t=final.trim();
    if(!t){return;}
    await doDetect(t);
  };
  sr.onerror=()=>{btn.classList.remove('on');setSoundwave(false);};
  try{sr.start();}catch(e){}
}
async function doDetect(transcript){
  overlay(true,'Detecting your languageâ€¦');
  function detectLangLocal(text){
    const te=(text.match(/[à°€-à±¿]/g)||[]).length;
    const hi=(text.match(/[à¤€-à¥¿]/g)||[]).length;
    const ta=(text.match(/[à®€-à¯¿]/g)||[]).length;
    const ml=(text.match(/[à´€-àµ¿]/g)||[]).length;
    const max=Math.max(te,hi,ta,ml);
    if(max===0)return null;
    if(te===max)return 'Telugu';
    if(hi===max)return 'Hindi';
    if(ta===max)return 'Tamil';
    if(ml===max)return 'Malayalam';
    return null;
  }
  function detectLangFromWords(text){
    const t=text.toLowerCase();
    const scores={Telugu:0,Hindi:0,Tamil:0,Malayalam:0,English:0};
    ['naa','mee','nenu','meeru','okati','rendu','jwaram','noppi','vayasu','peru','kadupu','gunde','cheppandi','ledhu','undi','ayindi','chestanu'].forEach(w=>{if(t.includes(w))scores.Telugu+=2;});
    ['mera','meri','naam','umar','main','hoon','hai','nahi','dard','bukhar','mujhe','aapka','bolo','kya','pet','sar','kamar'].forEach(w=>{if(t.includes(w))scores.Hindi+=2;});
    ['enakku','ennoda','peyar','vayasu','naan','irukku','vali','kaichal','vandhen','sollunga','enna','romba'].forEach(w=>{if(t.includes(w))scores.Tamil+=2;});
    ['entey','ente','peru','vayassu','njaan','aanu','veda','pani','paranju','parayoo','entha'].forEach(w=>{if(t.includes(w))scores.Malayalam+=2;});
    const best=Object.entries(scores).sort((a,b)=>b[1]-a[1])[0];
    return best[1]>=2?best[0]:null;
  }
  function applyLang(lang){
    overlay(false);
    S.lang=lang;
    const pm={English:'lp-en',Hindi:'lp-hi',Telugu:'lp-te',Tamil:'lp-ta',Malayalam:'lp-ml'};
    document.querySelectorAll('.lpill').forEach(p=>p.classList.remove('on'));
    document.getElementById(pm[S.lang])?.classList.add('on');
    document.getElementById('langLbl').textContent=S.lang;
    setTimeout(()=>startIntake(),400);
  }
  const local=detectLangLocal(transcript)||detectLangFromWords(transcript);
  if(local){applyLang(local);return;}
  try{
    const res=await fetch(BACKEND+'/detect-language',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({transcript})});
    const d=await res.json();
    applyLang(d.language||'English');
  }catch(e){overlay(false);toast('âŒ Backend error â€” is Flask running?');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INTAKE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startIntake(){
  show('si');
  S.step=0;
  document.getElementById('chat').innerHTML='';
  updateProgress(0);
  setTimeout(()=>askStep(0),300);
}

let _stepLock=-1;
function askStep(idx){
  if(idx>=KEYS.length){_stepLock=-1;showConfirm();return;}
  if(_stepLock===idx)return; // prevent duplicate for same step
  _stepLock=idx;
  S.step=idx;
  stepUI(idx,'active');
  updateProgress(idx);
  const key=KEYS[idx];
  const q=ph().q[idx];
  document.getElementById('mobBar').className='mobbar'+(key==='mobile'?' show':'');
  document.getElementById('keypad').className='keypad-wrap'+(key==='mobile'?' show':'');
  document.getElementById('mbtn').style.display=(key==='mobile'?'none':'');
  const mstatEl=document.getElementById('mstat');
  if(key==='mobile'){
    mobileDigits='';updateMobBar();
    mstatEl.className='mstat';
    mstatEl.textContent='âŒ¨ï¸ Use keypad below';
  }
  botMsg(SICOS[idx]+' '+q);
  micReady();
  speak(q, S.lang, ()=>{
    if(S.step===idx && key!=='mobile'){
      setTimeout(()=>{ startListen(idx); }, 800);
    } else if(key==='mobile'){
      mstatEl.className='mstat';
      mstatEl.textContent='âŒ¨ï¸ Use keypad below';
    }
  });
}

function reaskStep(idx){
  S[KEYS[idx]]='';
  show('si');
  botMsg('âœï¸ Re-entering: <b>'+KEYS[idx]+'</b>');
  askStep(idx);
}

function goBackToIntake(){
  show('si');
  let lastIdx=0;
  for(let i=0;i<KEYS.length;i++){if(S[KEYS[i]])lastIdx=i+1;}
  lastIdx=Math.min(lastIdx,KEYS.length-1);
  askStep(lastIdx);
}

// â”€â”€ CONFIRM SCREEN â”€â”€
function showConfirm(){
  const p=ph();
  document.getElementById('confirm-title').textContent=p.confirm_title;
  document.getElementById('confirm-sub').textContent=p.confirm_sub;
  document.getElementById('confirm-lang-msg').textContent=p.confirm_msg;
  document.getElementById('confirmBtn').textContent='âœ… '+p.confirm_btn;
  const rows=document.getElementById('confirmRows');
  rows.innerHTML='';
  const vals=[S.name,S.age,S.mobile,S.symptoms,S.days];
  KEYS.forEach((key,i)=>{
    const div=document.createElement('div');div.className='crow';
    div.innerHTML='<div><div class="crow-l">'+p.labels[i]+'</div><div class="crow-v">'+(vals[i]||'â€”')+'</div></div>'
      +'<button class="crow-edit" onclick="reaskStep('+i+')">âœï¸ Edit</button>';
    rows.appendChild(div);
  });
  show('sc');
  speak(p.confirm_msg, S.lang, null);
}

document.getElementById('confirmBtn').addEventListener('click',()=>finalize());

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LISTENING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let curSR=null;
let mobileDigits='';

document.getElementById('mbtn').addEventListener('click',()=>{
  stopAudio();
  if(curSR){try{curSR.abort();}catch(e){}curSR=null;}
  setTimeout(()=>startListen(S.step),300);
});

let _listenLock=false;
function startListen(idx){
  if(_listenLock){return;} // prevent double listen
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){toast('âŒ Please use Google Chrome');return;}
  const key=KEYS[idx];
  if(key==='mobile'){
    const mstatEl=document.getElementById('mstat');
    mstatEl.className='mstat';
    mstatEl.textContent='âŒ¨ï¸ Use keypad below';
    return;
  }
  _listenLock=true;
  const sr=new SR();curSR=sr;
  const SR_LANG={'English':'en-IN','Hindi':'hi-IN','Telugu':'te-IN','Tamil':'ta-IN','Malayalam':'ml-IN'};
  sr.lang=SR_LANG[S.lang]||'en-IN';
  sr.continuous=false;
  sr.interimResults=false;
  sr.maxAlternatives=3;
  micOn();
  let done=false;
  function finish(t){
    if(done)return;done=true;curSR=null;_listenLock=false;
    micBusy();
    if(!t){
      botMsg('ğŸ” '+ph().retry);
      speak(ph().retry,S.lang,null);
      micReady();
      return;
    }
    userMsg(t);
    if(key==='mobile')handleMob(idx,t);
    else processAns(idx,t);
  }
  sr.onresult=(e)=>{
    let best='';
    for(let i=0;i<e.results.length;i++)
      for(let j=0;j<e.results[i].length;j++)
        if(e.results[i][j].transcript.length>best.length) best=e.results[i][j].transcript;
    finish(best.trim());
  };
  sr.onend=()=>{if(!done)finish('');};
  sr.onerror=(e)=>{if(e.error!=='aborted')finish('');};
  setTimeout(()=>{if(!done){try{sr.stop();}catch(e){}}},10000);
  try{sr.start();}
  catch(e){micReady();toast('Tap mic to try again');}
}

function updateMobBar(){
  document.getElementById('mobBar').textContent=mobileDigits.padEnd(10,'_').split('').join(' ');
}
function handleMob(idx,t){
  mobileDigits=(mobileDigits+digits(t)).slice(0,10);
  updateMobBar();
  if(mobileDigits.length>=10){accept(idx,mobileDigits);return;}
  if(mobileDigits.length>=5){
    const need=10-mobileDigits.length;
    botMsg('ğŸ“± '+mobileDigits+' â€” '+need+' more digits needed');
    const moreMsg={
      Telugu:'à°‡à°‚à°•à°¾ '+need+' à°…à°‚à°•à±†à°²à± à°šà±†à°ªà±à°ªà°‚à°¡à°¿.',
      Hindi:need+' à¤…à¤‚à¤• à¤”à¤° à¤¬à¥‹à¤²à¥‡à¤‚à¥¤',
      Tamil:need+' à®‡à®²à®•à¯à®•à®™à¯à®•à®³à¯ à®®à¯‡à®²à¯à®®à¯ à®šà¯Šà®²à¯à®²à¯à®™à¯à®•à®³à¯.',
      Malayalam:need+' à´…à´•àµà´•à´™àµà´™àµ¾ à´•àµ‚à´Ÿà´¿ à´ªà´±à´¯àµ‚.',
      English:'Please say '+need+' more digits.'
    }[S.lang]||'Please say '+need+' more digits.';
    speak(moreMsg,S.lang,null);
    micReady();
  } else {
    botMsg('ğŸ” '+ph().retry);speak(ph().retry,S.lang,null);micReady();
  }
}

async function processAns(idx,transcript){
  botMsg('',true);overlay(true,'Processingâ€¦');
  try{
    const res=await fetch(BACKEND+'/extract',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({field:KEYS[idx],transcript,lang:S.lang})});
    const d=await res.json();
    rmTyping();overlay(false);
    const val=(d.extracted||'').trim();
    if(!val||val.toLowerCase()==='unknown'||val==='No medical keywords found.'||val==='No duration found.'){
      botMsg('ğŸ” '+ph().retry);
      speak(ph().retry,S.lang,null);
      micReady();
      return;
    }
    accept(idx,val);
  }catch(e){rmTyping();overlay(false);toast('âŒ Server busy â€” please try again');
        setTimeout(()=>{ micReady(); }, 1500);micReady();}
}

const CLANG = {
  name:{Telugu:'à°®à±€ à°ªà±‡à°°à± à°¨à°®à±‹à°¦à± à°šà±‡à°¶à°¾à°‚',Hindi:'à¤¨à¤¾à¤® à¤¦à¤°à¥à¤œ à¤•à¤¿à¤¯à¤¾',Tamil:'à®ªà¯†à®¯à®°à¯ à®ªà®¤à®¿à®µà¯',Malayalam:'à´ªàµ‡à´°àµ à´•àµà´±à´¿à´šàµà´šàµ',English:'Name recorded'},
  age:{Telugu:'à°µà°¯à°¸à± à°¨à°®à±‹à°¦à± à°šà±‡à°¶à°¾à°‚',Hindi:'à¤‰à¤®à¥à¤° à¤¦à¤°à¥à¤œ à¤•à¥€',Tamil:'à®µà®¯à®¤à¯ à®ªà®¤à®¿à®µà¯',Malayalam:'à´ªàµà´°à´¾à´¯à´‚ à´•àµà´±à´¿à´šàµà´šàµ',English:'Age recorded'},
  mobile:{Telugu:'à°®à±Šà°¬à±ˆà°²à± à°¨à°‚à°¬à°°à± à°¨à°®à±‹à°¦à± à°šà±‡à°¶à°¾à°‚',Hindi:'à¤®à¥‹à¤¬à¤¾à¤‡à¤² à¤¨à¤‚à¤¬à¤° à¤¦à¤°à¥à¤œ à¤•à¤¿à¤¯à¤¾',Tamil:'à®®à¯Šà®ªà¯ˆà®²à¯ à®ªà®¤à®¿à®µà¯',Malayalam:'à´®àµŠà´¬àµˆàµ½ à´•àµà´±à´¿à´šàµà´šàµ',English:'Mobile recorded'},
  symptoms:{Telugu:'à°²à°•à±à°·à°£à°¾à°²à± à°¨à°®à±‹à°¦à± à°šà±‡à°¶à°¾à°‚',Hindi:'à¤²à¤•à¥à¤·à¤£ à¤¨à¥‹à¤Ÿ à¤•à¤¿à¤',Tamil:'à®…à®±à®¿à®•à¯à®±à®¿à®•à®³à¯ à®•à¯à®±à®¿à®ªà¯à®ªà®¿à®Ÿà®ªà¯à®ªà®Ÿà¯à®Ÿà®©',Malayalam:'à´²à´•àµà´·à´£à´™àµà´™àµ¾ à´•àµà´±à´¿à´šàµà´šàµ',English:'Symptoms noted'},
  days:{Telugu:'à°µà±à°¯à°µà°§à°¿ à°¨à°®à±‹à°¦à± à°šà±‡à°¶à°¾à°‚',Hindi:'à¤…à¤µà¤§à¤¿ à¤¨à¥‹à¤Ÿ à¤•à¥€',Tamil:'à®•à®¾à®²à®®à¯ à®•à¯à®±à®¿à®ªà¯à®ªà®¿à®Ÿà®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯',Malayalam:'à´¦àµˆàµ¼à´˜àµà´¯à´‚ à´•àµà´±à´¿à´šàµà´šàµ',English:'Duration noted'}
};

function accept(idx,val){
  const key=KEYS[idx];
  S[key]=val;
  rmTyping();
  const cm=(CLANG[key]||{})[S.lang]||(CLANG[key]||{})['English']||'Recorded';
  if(key==='mobile'){
    botMsg('âœ… '+cm);
    speak(cm, S.lang, ()=>{ stepUI(idx,'done'); _stepLock=-1; askStep(idx+1); });
  } else if(key==='symptoms'){
    botMsg('âœ… <span style="font-size:12px;color:var(--text2)">'+val+'</span><br><b>'+cm+'</b>');
    speak(cm, S.lang, ()=>{ stepUI(idx,'done'); _stepLock=-1; askStep(idx+1); });
  } else {
    botMsg('âœ… '+val+'<br><span style="font-size:12px;color:var(--text2)">'+cm+'</span>');
    speak(cm+'. '+val, S.lang, ()=>{ stepUI(idx,'done'); _stepLock=-1; askStep(idx+1); });
  }
  document.getElementById('mobBar').className='mobbar';
  document.getElementById('keypad').className='keypad-wrap';
  document.getElementById('mbtn').style.display='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FINALIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function finalize(){
  overlay(true,'Mapping departmentâ€¦');
  try{
    const res=await fetch(BACKEND+'/process',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name:S.name,age:S.age,mobile:S.mobile,symptoms:S.symptoms,days:S.days,language:S.lang,emergency:S.emergency})});
    const d=await res.json();
    overlay(false);
    Object.assign(S,{department:d.department,floor:d.floor,floorWord:d.floorWord,
      doctor:d.doctor,keywords:d.keywords,emergency:d.emergency,reg:d.registration_number,
      all_departments:d.all_departments||[]});
    if(S.emergency){
      show('se');
      const em={Telugu:'à°…à°¤à±à°¯à°µà°¸à°°à°‚! à°—à±à°°à±Œà°‚à°¡à± à°«à±à°²à±‹à°°à± à°•à°¿ à°µà±†à°³à±à°³à°‚à°¡à°¿.',Hindi:'à¤†à¤ªà¤¾à¤¤à¤•à¤¾à¤²! à¤—à¥à¤°à¤¾à¤‰à¤‚à¤¡ à¤«à¥à¤²à¥‹à¤° à¤ªà¤° à¤œà¤¾à¤à¤‚à¥¤',
        Tamil:'à®…à®µà®šà®°à®¨à®¿à®²à¯ˆ! à®•à¯€à®´à¯ à®¤à®³à®¤à¯à®¤à®¿à®±à¯à®•à¯ à®šà¯†à®²à¯à®²à¯à®™à¯à®•à®³à¯.',Malayalam:'à´…à´Ÿà´¿à´¯à´¨àµà´¤à´°à´‚! à´—àµà´°àµ—à´£àµà´Ÿàµ à´«àµà´²àµ‹à´±à´¿à´²àµ‡à´•àµà´•àµ à´ªàµ‹à´•àµ‚.',
        English:'Emergency! Go to Ground Floor immediately.'}[S.lang]||'Emergency!';
      speak(em,S.lang,null);
      setTimeout(()=>{show('sr2');fillReceipt();},7000);
    }else{
      const msg=ph().floor_msg+S.floor;
      show('sr2');
      fillReceipt();
      speak(msg,S.lang,null);
    }
  }catch(e){
    overlay(false);
    // Show retry button instead of just error
    toast('âŒ Connection issue â€” tap mic and try again');
    micReady();
  }
}

// â”€â”€ RECEIPT â”€â”€
function fillReceipt(){
  const d=new Date();
  const reg=S.reg||'VBT-'+d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0')+'-'+String(Math.floor(Math.random()*900)+100);
  // Token number â€” random between 1-99 for demo
  const token = 'T-' + String(Math.floor(Math.random()*98)+1).padStart(2,'0');
  document.getElementById('r-reg').textContent=reg;
  document.getElementById('r-token').textContent=token;
  document.getElementById('r-wait').textContent='Show this token at the department counter';
  document.getElementById('r-dept').textContent=S.department||'â€”';
  document.getElementById('r-doc').textContent=S.doctor||'â€”';
  // Show additional departments if multiple
  const multiEl=document.getElementById('r-multidept');
  const multiList=document.getElementById('r-multidept-list');
  const others=(S.all_departments||[]).filter(d=>d.name!==S.department && d.name!=='Emergency');
  if(others.length>0){
    multiList.innerHTML=others.map(function(d){
      return '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #e0e7ff;font-size:13px;">'
        +'<span style="font-weight:600;color:#1e293b;">ğŸ¥ '+d.name+'</span>'
        +'<span style="color:#64748b;">Floor '+d.floor+' &middot; '+d.doctor+'</span>'
        +'</div>';
    }).join('');
    multiEl.style.display='block';
  }else{
    multiEl.style.display='none';
  }
  document.getElementById('r-fl').textContent=S.floor;
  document.getElementById('r-flw').textContent=S.floorWord||'â€”';
  document.getElementById('r-name').textContent=S.name||'â€”';
  document.getElementById('r-age').textContent=S.age?S.age+' years':'â€”';
  document.getElementById('r-mob').textContent=S.mobile||'â€”';
  document.getElementById('r-lang').textContent=S.lang;
  document.getElementById('r-days').textContent=S.days||'â€”';
  document.getElementById('r-time').textContent=d.toLocaleString('en-IN');
  const pri=document.getElementById('r-pri');
  if(S.emergency){pri.textContent='HIGH PRIORITY';pri.className='pb hi';}
  else{pri.textContent='Normal Priority';pri.className='pb norm';}
  const sw=document.getElementById('r-sym');sw.innerHTML='';
  (S.keywords||[]).forEach(k=>{const sp=document.createElement('span');sp.className='spill';sp.textContent=k;sw.appendChild(sp);});
}

// â”€â”€ PRINT / DOWNLOAD â”€â”€
let cdTimer,cdDone=false;
function doPrint(){window.print();toast('ğŸ–¨ï¸ Sent to printer');setTimeout(startCD,1500);}
function doDownload(){
  const html='<!DOCTYPE html><html><head><meta charset="UTF-8"/></head><body>'+document.getElementById('rcard').outerHTML+'</body></html>';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([html],{type:'text/html'}));
  a.download='VoiceByte-'+document.getElementById('r-reg').textContent+'.html';
  a.click();toast('â¬‡ï¸ Downloaded!');setTimeout(startCD,1500);
}
function startCD(){
  if(cdDone)return;cdDone=true;let s=10;
  document.getElementById('cdmsg').textContent='Session expiring in';
  document.getElementById('cdnum').textContent=s+'s';
  document.getElementById('cdf').style.width='100%';
  clearInterval(cdTimer);
  cdTimer=setInterval(()=>{s--;document.getElementById('cdnum').textContent=s+'s';document.getElementById('cdf').style.width=(s/10*100)+'%';if(s<=0){clearInterval(cdTimer);resetAll();}},1000);
}

// â”€â”€ RESET â”€â”€
function resetAll(){
  clearInterval(cdTimer);cdDone=false;stopAudio();
  if(curSR){try{curSR.abort();}catch(e){}curSR=null;}
  Object.assign(S,{lang:'English',step:0,name:'',age:'',mobile:'',symptoms:'',days:'',department:'',floor:1,floorWord:'',doctor:'',keywords:[],emergency:false,reg:'',all_departments:[]});
  mobileDigits='';
  document.getElementById('chat').innerHTML='';
  document.getElementById('langLbl').textContent='English';
  document.querySelectorAll('.lpill').forEach(p=>p.classList.remove('on'));
  const icons=['ğŸ‘¤','ğŸ‚','ğŸ“±','ğŸ¥','ğŸ“…'];
  for(let i=1;i<=5;i++){
    const el=document.getElementById('si-'+i);
    el.className='si-el'+(i===1?' active':'');
    el.querySelector('.sico').textContent=icons[i-1];
    el.style.cursor='';el.onclick=null;
  }
  document.getElementById('mobBar').className='mobbar';
  updateProgress(0);
  show('sw');
}

// Pre-load voices immediately on page load
if(window.speechSynthesis){
  window.speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = function(){
    window.speechSynthesis.getVoices(); // ensure voices loaded
  };
}

document.getElementById('startBtn').addEventListener('click', function(){
  if(window.speechSynthesis) window.speechSynthesis.getVoices();
  startDetect();
});

// Ping backend on load â€” shows splash if Render is waking up
(async function pingBackend(){
  const splash=document.createElement('div');
  splash.id='renderSplash';
  Object.assign(splash.style,{display:'none',position:'fixed',inset:'0',zIndex:'9999',
    background:'#0F2137',flexDirection:'column',alignItems:'center',justifyContent:'center',
    gap:'18px',fontFamily:'sans-serif'});
  splash.innerHTML=`<div style="font-size:56px">ğŸ¥</div>
    <div style="font-size:26px;font-weight:800;color:#fff"><span style="color:#93C5FD">Voice</span>Byte</div>
    <div style="color:rgba(255,255,255,0.7);font-size:15px">Starting up, please waitâ€¦</div>
    <div style="width:180px;height:4px;background:rgba(255,255,255,0.15);border-radius:4px;overflow:hidden">
      <div id="splashBar" style="height:100%;width:0%;background:#3B82F6;border-radius:4px;transition:width 0.4s"></div></div>
    <div id="splashMsg" style="color:rgba(255,255,255,0.4);font-size:12px">Connectingâ€¦</div>`;
  document.body.appendChild(splash);
  let pct=0;
  const tick=setInterval(()=>{pct=Math.min(pct+3,88);document.getElementById('splashBar').style.width=pct+'%';},600);
  const slowTimer=setTimeout(()=>{
    splash.style.display='flex';
    document.getElementById('splashMsg').textContent='Free server waking up (may take 30-50s)â€¦';
  },3000);
  try{
    await fetch(BACKEND+'/health',{cache:'no-store'});
    clearTimeout(slowTimer);clearInterval(tick);
    document.getElementById('splashBar').style.width='100%';
    setTimeout(()=>{splash.style.display='none';},400);
  }catch(e){
    clearInterval(tick);
    if(splash.style.display==='flex')
      document.getElementById('splashMsg').textContent='Cannot reach server. Check Flask is running.';
  }
})();

// â”€â”€ NUMBER KEYPAD â”€â”€
function kp(digit){
  if(mobileDigits.length>=10) return;
  mobileDigits+=digit;
  updateMobBar();
}
function kpDel(){
  mobileDigits=mobileDigits.slice(0,-1);
  updateMobBar();
}
function kpOk(){
  if(mobileDigits.length<7){
    const msg={Telugu:'10 à°…à°‚à°•à±†à°²à± à°ªà±‚à°°à±à°¤à°¿à°—à°¾ à°¨à°®à±‹à°¦à± à°šà±‡à°¯à°‚à°¡à°¿',Hindi:'10 à¤…à¤‚à¤• à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚',
      Tamil:'10 à®‡à®²à®•à¯à®•à®™à¯à®•à®³à¯ à®‰à®³à¯à®³à®¿à®Ÿà¯à®™à¯à®•à®³à¯',Malayalam:'10 à´…à´•àµà´•à´™àµà´™àµ¾ à´¨àµ½à´•àµ‚',
      English:'Please enter at least 7 digits'}[S.lang]||'Please enter at least 7 digits';
    toast(msg); return;
  }
  userMsg(mobileDigits);
  accept(S.step, mobileDigits);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IDLE DETECTION â€” 30 seconds
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IDLE_SEC = 30;
let idleTimer = null;
let idleLangTimer = null;

const IDLE_MSGS = [
  { lang:'English',  msg:'Touch the button to register' },
  { lang:'à¤¹à¤¿à¤‚à¤¦à¥€',    msg:'à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£ à¤•à¥‡ à¤²à¤¿à¤ à¤¬à¤Ÿà¤¨ à¤¦à¤¬à¤¾à¤à¤‚' },
  { lang:'à°¤à±†à°²à±à°—à±',  msg:'à°¨à°®à±‹à°¦à± à°šà±‡à°¯à°¡à°¾à°¨à°¿à°•à°¿ à°¬à°Ÿà°¨à± à°¨à±Šà°•à±à°•à°‚à°¡à°¿' },
  { lang:'à®¤à®®à®¿à®´à¯',   msg:'à®ªà®¤à®¿à®µà¯ à®šà¯†à®¯à¯à®¯ à®ªà¯Šà®¤à¯à®¤à®¾à®©à¯ˆ à®¤à¯Šà®Ÿà¯à®™à¯à®•à®³à¯' },
  { lang:'à´®à´²à´¯à´¾à´³à´‚', msg:'à´°à´œà´¿à´¸àµà´Ÿàµà´°àµ‡à´·à´¨à´¾à´¯à´¿ à´¬à´Ÿàµà´Ÿàµº à´…à´®àµ¼à´¤àµà´¤àµ‚' },
];

// Start idle timer only after user has interacted at least once (or after 30s on welcome)
// Don't show idle on first page load â€” give patient time to read
let hasInteracted = false;

function resetIdleTimer(){
  clearTimeout(idleTimer);
  if(document.getElementById('sw').classList.contains('active') && hasInteracted){
    idleTimer = setTimeout(showIdle, IDLE_SEC * 1000);
  }
}

// Mark first interaction
document.addEventListener('click', ()=>{ hasInteracted=true; resetIdleTimer(); }, {once:true});
document.addEventListener('touchstart', ()=>{ hasInteracted=true; resetIdleTimer(); }, {once:true, passive:true});

// After 30s on welcome even without interaction â€” show idle
setTimeout(()=>{ hasInteracted=true; resetIdleTimer(); }, IDLE_SEC * 1000);

function showIdle(){
  document.getElementById('idle-overlay').style.display='flex';
  let i=0;
  clearInterval(idleLangTimer);
  function rotate(){
    const el=document.getElementById('idle-lang-msg');
    el.style.opacity='0';
    setTimeout(()=>{
      el.textContent=IDLE_MSGS[i].lang+' â€” '+IDLE_MSGS[i].msg;
      el.style.opacity='1';
      i=(i+1)%IDLE_MSGS.length;
    },400);
  }
  rotate();
  idleLangTimer=setInterval(rotate,2500);
}

function dismissIdle(){
  clearInterval(idleLangTimer);
  document.getElementById('idle-overlay').style.display='none';
  resetAll();
  setTimeout(resetIdleTimer,500);
}

// Patch resetAll to restart idle when welcome screen shown
const _baseResetAll = resetAll;
resetAll = function(){
  _baseResetAll();
  setTimeout(resetIdleTimer, 500);
};

['click','touchstart','keydown'].forEach(ev=>{
  document.addEventListener(ev,()=>{
    hasInteracted = true;
    if(document.getElementById('idle-overlay').style.display!=='flex') resetIdleTimer();
  },{passive:true});
});

// Don't call resetIdleTimer() here â€” handled above with delay
</script>

<!-- IDLE OVERLAY -->
<div id="idle-overlay" style="display:none;position:fixed;inset:0;z-index:500;background:linear-gradient(135deg,#0F2137,#1252A3);flex-direction:column;align-items:center;justify-content:center;gap:24px;text-align:center;padding:32px;">
  <div style="font-size:80px;animation:logo-float 3s ease-in-out infinite;">ğŸ¥</div>
  <div style="font-family:'Plus Jakarta Sans',sans-serif;font-size:36px;font-weight:800;color:#fff;letter-spacing:-0.5px;">VoiceByte</div>
  <div style="font-size:15px;color:rgba(255,255,255,0.6);">AI-powered Hospital Registration</div>
  <div id="idle-lang-msg" style="font-size:20px;font-weight:600;color:#93C5FD;min-height:30px;transition:opacity .4s;"></div>
  <button onclick="dismissIdle()" style="margin-top:12px;padding:20px 52px;border:none;border-radius:18px;background:#fff;color:#1252A3;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:18px;cursor:pointer;box-shadow:0 8px 32px rgba(0,0,0,0.3);transition:transform .2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
    ğŸ¤ &nbsp;Touch here to start
  </button>
  <div style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:8px;">City General Hospital Â· Powered by VoiceByte AI</div>
</div>

</body>
</html>